<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Sistema de Escala de Servi√ßo - Google Sheets v4.0</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700;800&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
:root {
    --bg-gradient-start: #0f172a;
    --bg-gradient-end: #1e293b;
    --card-bg: #ffffff;
    --text-color: #1e293b;
    --header-bg: #3b82f6;
    --header-text: #fff;
    --border-color: #e2e8f0;
    --info-box-bg: #f0f9ff;
    --accent-color: #8b5cf6;
    --success-color: #10b981;
    --warning-color: #f59e0b;
    --danger-color: #ef4444;
}
body.dark-mode {
    --bg-gradient-start: #020617;
    --bg-gradient-end: #0f172a;
    --card-bg: #1e293b;
    --text-color: #e2e8f0;
    --header-bg: #3b82f6;
    --header-text: #fff;
    --border-color: #334155;
    --info-box-bg: #1e3a5f;
}
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}
body{
    font-family: 'Outfit', sans-serif;
    background: linear-gradient(135deg, var(--bg-gradient-start), var(--bg-gradient-end));
    color: var(--text-color);
    transition: all 0.3s ease;
    min-height:100vh;
    line-height: 1.6;
}
.container{
    max-width:1600px; 
    margin:auto; 
    padding:40px 20px;
}
.header-controls{
    display:flex; 
    justify-content:space-between; 
    align-items:center; 
    margin-bottom:40px; 
    flex-wrap:wrap; 
    gap:20px;
    padding: 30px;
    background: rgba(255,255,255,0.05);
    backdrop-filter: blur(10px);
    border-radius: 20px;
    border: 1px solid rgba(255,255,255,0.1);
}
h1{
    color:#fff; 
    margin:0;
    font-size: 2.5rem;
    font-weight: 800;
    letter-spacing: -1px;
    text-shadow: 0 2px 20px rgba(0,0,0,0.3);
}
.sheets-link{
    background: var(--card-bg);
    padding:12px 24px;
    border-radius:30px;
    text-decoration:none;
    color: var(--text-color);
    font-weight:600;
    display:flex;
    align-items:center;
    gap:10px;
    transition: all 0.3s;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}
.sheets-link:hover{
    transform: translateY(-3px); 
    box-shadow: 0 6px 25px rgba(0,0,0,0.2);
}
.sync-badge{
    background: var(--card-bg); 
    padding:12px 24px; 
    border-radius:30px; 
    font-size:14px; 
    display:flex; 
    align-items:center; 
    gap:10px; 
    font-weight:600;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}
.sync-indicator{
    width:12px; 
    height:12px; 
    border-radius:50%; 
    background:#10b981; 
    animation: pulse 2s infinite;
    box-shadow: 0 0 10px currentColor;
}
.sync-indicator.syncing{background:#3b82f6;}
.sync-indicator.error{background:#ef4444;}
@keyframes pulse { 
    0%, 100% { opacity: 1; transform: scale(1); } 
    50% { opacity: 0.6; transform: scale(1.2); } 
}
.theme-toggle{
    background: var(--card-bg); 
    border:none; 
    padding:12px 24px; 
    border-radius:30px; 
    cursor:pointer; 
    color: var(--text-color); 
    font-weight:600;
    transition: all 0.3s;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    font-family: 'Outfit', sans-serif;
}
.theme-toggle:hover{
    transform: translateY(-3px);
    box-shadow: 0 6px 25px rgba(0,0,0,0.2);
}
.card{
    background: var(--card-bg); 
    border-radius:24px; 
    padding:35px; 
    margin-bottom:30px; 
    box-shadow:0 10px 40px rgba(0,0,0,.15);
    border: 1px solid var(--border-color);
    transition: all 0.3s ease;
}
.card:hover{
    transform: translateY(-2px);
    box-shadow:0 15px 50px rgba(0,0,0,.2);
}
.card h2{
    margin-top:0; 
    color: var(--header-bg);
    font-size: 1.8rem;
    font-weight: 700;
    margin-bottom: 25px;
    letter-spacing: -0.5px;
}
body.dark-mode .card h2{color: #60a5fa;}
.filtros-avancados{
    background: var(--info-box-bg); 
    padding:25px; 
    border-radius:16px; 
    margin-bottom:25px;
    border: 1px solid var(--border-color);
}
.filtro-grid{
    display:grid; 
    grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); 
    gap:15px; 
    margin-bottom:20px;
}
.filtro-actions{
    display:flex; 
    gap:12px; 
    flex-wrap:wrap;
    align-items: center;
}
.btn-filtro{
    padding:12px 24px; 
    border-radius:12px; 
    border:none; 
    cursor:pointer; 
    background: var(--header-bg); 
    color: var(--header-text); 
    font-weight:600; 
    transition: all 0.2s;
    font-family: 'Outfit', sans-serif;
    font-size: 14px;
}
.btn-filtro:hover{
    opacity:0.9; 
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}
.btn-limpar{background:#f59e0b;}
.widgets-container{
    display:grid; 
    grid-template-columns:repeat(auto-fit,minmax(280px,1fr)); 
    gap:25px; 
    margin-bottom:30px;
}
.widget{
    background: var(--card-bg); 
    border-radius:20px; 
    padding:25px; 
    box-shadow:0 10px 40px rgba(0,0,0,.15);
    border: 1px solid var(--border-color);
    transition: all 0.3s ease;
}
.widget:hover{
    transform: translateY(-3px);
    box-shadow:0 15px 50px rgba(0,0,0,.2);
}
.widget h3{
    margin:0 0 20px 0; 
    color: var(--header-bg); 
    font-size:18px; 
    border-bottom:2px solid var(--border-color); 
    padding-bottom:12px;
    font-weight: 700;
}
body.dark-mode .widget h3{color:#60a5fa;}
.mini-calendario{
    display:grid; 
    grid-template-columns:repeat(7,1fr); 
    gap:4px;
}
.mini-dia{
    padding:8px 4px; 
    text-align:center; 
    font-size:11px; 
    border-radius:6px; 
    min-height:32px; 
    display:flex; 
    align-items:center; 
    justify-content:center;
    font-weight: 600;
    transition: all 0.2s;
}
.mini-dia:hover:not(.mini-header){
    transform: scale(1.1);
    z-index: 10;
}
.mini-header{
    font-weight:700; 
    background: var(--header-bg); 
    color: var(--header-text);
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}
.mini-servico-normal{background:#10b981; color:#fff; font-weight:700;}
.mini-servico-extra{background:#3b82f6; color:#fff; font-weight:700;}
.mini-servico-falta{background:#f59e0b; color:#fff; font-weight:700;}
.mini-servico-ferias{background:#8b5cf6; color:#fff; font-weight:700;}
.mini-folga{background:#f1f5f9; color:#64748b;}
body.dark-mode .mini-folga{background:#334155; color:#94a3b8;}
.mini-hoje{
    border:2px solid #ef4444; 
    font-weight:700;
    box-shadow: 0 0 12px rgba(239, 68, 68, 0.5);
}
.print-header{display:none;}
.qr-code-container{text-align:center; margin:30px 0;}
#qrcode{
    display:inline-block; 
    padding:20px; 
    background:white; 
    border-radius:16px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
}
@media print {
    .no-print { display: none !important; }
    body { background: white !important; color: black !important; margin:0; padding:0; }
    .container{max-width:100%; padding:10mm;}
    .card { box-shadow: none !important; page-break-inside: avoid; border:1px solid #ccc; margin-bottom:10mm; }
    .print-header{display:block; text-align:center; margin-bottom:15px; padding-bottom:10px; border-bottom:2px solid #3b82f6;}
    .print-header h1{color:#3b82f6; margin:0; font-size:24px;}
    .print-header p{margin:5px 0; font-size:12px; color:#666;}
    .qr-code-container{page-break-before: avoid;}
    table{font-size:10px;}
    th, td{padding:4px;}
}
form{
    display:grid; 
    grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); 
    gap:15px; 
    margin-bottom:20px;
}
input, select, button, textarea{
    padding:14px 18px; 
    border-radius:12px; 
    border:1px solid var(--border-color); 
    background: var(--card-bg); 
    color: var(--text-color);
    font-family: 'Outfit', sans-serif;
    font-size: 14px;
    transition: all 0.2s;
}
input:focus, select:focus, textarea:focus{
    outline: none;
    border-color: var(--header-bg);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}
button{
    background: var(--header-bg); 
    color: var(--header-text); 
    cursor:pointer; 
    border:none; 
    transition: all 0.2s;
    font-weight: 600;
}
button:hover{
    opacity:0.9; 
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}
.btn-edit{
    background:#10b981; 
    color:#fff; 
    border:none; 
    padding:8px 16px; 
    border-radius:8px; 
    cursor:pointer; 
    margin-right:8px;
    font-weight: 600;
    font-size: 13px;
    transition: all 0.2s;
}
.btn-edit:hover{
    background:#059669;
    transform: translateY(-1px);
}
.btn-del{
    background:#ef4444; 
    color:#fff; 
    border:none; 
    padding:8px 16px; 
    border-radius:8px; 
    cursor:pointer;
    font-weight: 600;
    font-size: 13px;
    transition: all 0.2s;
}
.btn-del:hover{
    background:#dc2626;
    transform: translateY(-1px);
}
table{
    width:100%; 
    border-collapse:collapse; 
    margin-top:20px;
    border-radius: 12px;
    overflow: hidden;
}
th, td{
    padding:14px 12px; 
    border:1px solid var(--border-color); 
    text-align:center;
    font-size: 14px;
}
th{
    background: var(--header-bg); 
    color: var(--header-text);
    font-weight: 700;
    text-transform: uppercase;
    font-size: 12px;
    letter-spacing: 0.5px;
}
tbody tr{
    transition: all 0.2s;
}
tbody tr:hover{
    background: var(--info-box-bg);
    transform: scale(1.01);
}
.oculto{display:none;}
.info-box{
    background: var(--info-box-bg); 
    padding:20px; 
    border-radius:12px; 
    margin-bottom:20px; 
    font-size:14px;
    border: 1px solid var(--border-color);
    line-height: 1.8;
}
.calendario-mini{
    display:grid; 
    grid-template-columns:repeat(7,1fr); 
    gap:8px; 
    margin-top:20px;
}
.dia-calendario{
    padding:16px 12px; 
    border:1px solid var(--border-color); 
    border-radius:12px; 
    text-align:center; 
    font-size:14px; 
    cursor:pointer; 
    transition: all 0.2s; 
    min-height:60px; 
    display:flex; 
    flex-direction:column; 
    justify-content:center;
    font-weight: 600;
    position: relative;
    overflow: hidden;
}
.dia-calendario::before{
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, transparent, rgba(255,255,255,0.1));
    opacity: 0;
    transition: opacity 0.3s;
}
.dia-calendario:hover::before{
    opacity: 1;
}
.dia-calendario:hover:not(.dia-header){
    transform: scale(1.08);
    box-shadow: 0 8px 25px rgba(0,0,0,0.2);
    z-index: 10;
}
.dia-servico-normal{background:#10b981; color:#fff; font-weight:700;}
.dia-servico-extra{background:#3b82f6; color:#fff; font-weight:700;}
.dia-servico-falta{background:#f59e0b; color:#fff; font-weight:700;}
.dia-servico-ferias{background:#8b5cf6; color:#fff; font-weight:700;}
.dia-folga{background:#f1f5f9; color:#64748b;}
body.dark-mode .dia-folga{background:#334155; color:#94a3b8;}
.dia-header{
    background: var(--header-bg); 
    color: var(--header-text); 
    font-weight:700;
    text-transform: uppercase;
    font-size: 12px;
    letter-spacing: 1px;
}
.dia-passado{opacity:0.5;}
.mes-navegacao{
    display:flex; 
    justify-content:space-between; 
    align-items:center; 
    margin-bottom:25px; 
    gap:15px; 
    flex-wrap:wrap;
}
.mes-navegacao button{
    padding:12px 24px;
    font-weight: 600;
}
.mes-navegacao h3{
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--text-color);
}
.view-controls{
    display:flex; 
    gap:12px; 
    margin-bottom:25px; 
    flex-wrap:wrap;
}
.view-controls button, .view-controls select{
    padding:12px 24px; 
    flex:1; 
    min-width:140px;
    font-weight: 600;
}
.view-controls button.active{
    background:#10b981;
    box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
}
.legenda{
    margin-top:25px; 
    display:flex; 
    gap:25px; 
    justify-content:center; 
    font-size:14px; 
    flex-wrap:wrap;
    padding: 20px;
    background: var(--info-box-bg);
    border-radius: 12px;
}
.legenda-item{
    display:flex; 
    align-items:center; 
    gap:10px;
    font-weight: 600;
}
.legenda-cor{
    display:inline-block; 
    width:24px; 
    height:24px; 
    border-radius:6px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}
.stats-grid{
    display:grid; 
    grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); 
    gap:20px; 
    margin-top:25px;
}
.stat-card{
    background: var(--info-box-bg); 
    padding:30px; 
    border-radius:16px; 
    text-align:center;
    border: 1px solid var(--border-color);
    transition: all 0.3s;
}
.stat-card:hover{
    transform: translateY(-5px);
    box-shadow: 0 10px 30px rgba(0,0,0,0.15);
}
.stat-number{
    font-size:48px; 
    font-weight:800; 
    color: var(--header-bg); 
    margin:15px 0;
    font-family: 'Space Mono', monospace;
}
body.dark-mode .stat-number{color:#60a5fa;}
.stat-label{
    font-size:14px; 
    color: var(--text-color); 
    opacity:0.8;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}
footer{
    text-align:center; 
    color:#fff; 
    margin-top:50px; 
    font-size:14px;
    opacity: 0.7;
    font-weight: 500;
}
@media (max-width: 768px){
    .calendario-mini{gap:4px;}
    .dia-calendario{padding:8px 4px; font-size:12px; min-height:45px;}
    .widgets-container{grid-template-columns:1fr;}
    h1{font-size: 1.8rem;}
    .header-controls{padding: 20px;}
}

/* Anima√ß√µes de entrada */
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.card {
    animation: fadeInUp 0.6s ease-out;
}

.widget {
    animation: fadeInUp 0.6s ease-out;
}
</style>
</head>
<body>
<div class="container">
<div class="header-controls no-print">
<h1>üìÖ Sistema de Escala v4.0</h1>
<div style="display:flex;gap:15px;align-items:center;flex-wrap:wrap;">
    <a href="#" id="sheetsLinkHeader" class="sheets-link" target="_blank" style="display:none;">
        üìä Abrir Google Sheets
    </a>
    <div class="sync-badge">
        <div class="sync-indicator" id="syncIndicator"></div>
        <span id="syncStatus">Sincronizado ‚òÅÔ∏è</span>
    </div>
    <button class="theme-toggle" onclick="toggleTheme()">üåì Tema</button>
</div>
</div>

<div class="card no-print">
<div class="info-box" style="text-align:center;">
    <span id="apiStatus">‚òÅÔ∏è <strong>Conectado ao Google Sheets</strong> - Sincroniza√ß√£o autom√°tica a cada 5 segundos</span>
</div>
</div>

<div class="widgets-container no-print">
    <div class="widget">
        <h3>üìÖ M√™s Atual</h3>
        <div id="widgetMesAtual"></div>
    </div>
    <div class="widget">
        <h3>üìä Resumo R√°pido</h3>
        <div id="widgetResumo" style="padding:10px;">
            <div style="margin:5px 0;"><strong>Este m√™s:</strong></div>
            <div id="resumoMes" style="font-size:13px;line-height:2;"></div>
        </div>
    </div>
    <div class="widget">
        <h3>üîî Pr√≥ximos Servi√ßos</h3>
        <div id="widgetProximos" style="font-size:13px;line-height:2;padding:10px;"></div>
    </div>
</div>

<div class="card no-print">
<h2>üîç Filtros Avan√ßados</h2>
<div class="filtros-avancados">
    <div class="filtro-grid">
        <input type="text" id="filtroNome" placeholder="üîç Buscar por nome">
        <input type="text" id="filtroFuncao" placeholder="üîç Buscar por fun√ß√£o">
        <select id="filtroTipoServico">
            <option value="">Todos os tipos</option>
            <option value="normal">üü¢ Servi√ßo Normal</option>
            <option value="extra">üîµ Servi√ßo Extra</option>
            <option value="falta">üü† Falta/Atestado</option>
            <option value="ferias">üü£ F√©rias</option>
        </select>
        <input type="date" id="filtroPeriodoInicio" placeholder="Per√≠odo in√≠cio">
        <input type="date" id="filtroPeriodoFim" placeholder="Per√≠odo fim">
    </div>
    <div class="filtro-actions">
        <button class="btn-filtro" onclick="aplicarFiltros()">üîç Aplicar</button>
        <button class="btn-filtro btn-limpar" onclick="limparFiltros()">üóëÔ∏è Limpar</button>
        <button class="btn-filtro" onclick="exportarFiltrados()">üìÑ Exportar</button>
        <span id="resultadoFiltro" style="padding:8px;color:var(--text-color);font-weight:bold;"></span>
    </div>
</div>
</div>

<div class="card">
<h2>üìä Estat√≠sticas</h2>
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-label">Servi√ßos Normais</div>
        <div class="stat-number" id="statNormais">0</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Servi√ßos Extras</div>
        <div class="stat-number" id="statExtras">0</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Faltas/Atestados</div>
        <div class="stat-number" id="statFaltas">0</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Dispensa M√©dica</div>
        <div class="stat-number" id="statDispensa">0</div>
        <small style="font-size:11px;opacity:0.7;">(Acima de 8 dias)</small>
    </div>
    <div class="stat-card">
        <div class="stat-label">F√©rias</div>
        <div class="stat-number" id="statFerias">0</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Avulso/Permuta</div>
        <div class="stat-number" id="statAvulso">0</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Total de Folgas</div>
        <div class="stat-number" id="statFolgas">0</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Dias Trabalhados</div>
        <div class="stat-number" id="statTotal">0</div>
    </div>
</div>
</div>

<div class="card no-print">
<h2>üîÑ Escala Recorrente</h2>
<div class="info-box">
    <strong>üí° Dica:</strong> Configure escalas que se repetem automaticamente. Agora com suporte para <strong>f√©rias</strong>!
</div>
<form id="formEscalaPlantonista">
    <input type="text" id="nomePlantonista" placeholder="Nome" required>
    <input type="text" id="funcaoPlantonista" placeholder="Fun√ß√£o" required>
    <select id="tipoServico" required onchange="ajustarCamposTipoServico()">
        <option value="">Tipo de Servi√ßo</option>
        <option value="normal">üü¢ Servi√ßo Normal</option>
        <option value="extra">üîµ Servi√ßo Extra</option>
        <option value="falta">üü† Falta/Atestado</option>
        <option value="ferias">üü£ F√©rias</option>
    </select>
    
    <div id="camposExtraFalta" class="oculto" style="grid-column:1/-1;">
        <div style="background:var(--info-box-bg);padding:20px;border-radius:12px;margin-top:15px;">
            <p style="margin:0 0 15px 0;font-weight:bold;">‚ö†Ô∏è Configura√ß√£o de Servi√ßo √önico</p>
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:15px;">
                <input type="date" id="dataUnicaServico" placeholder="Data inicial">
                <input type="number" id="qtdDiasServico" placeholder="Quantidade de dias" min="1" max="365">
            </div>
            <small style="display:block;margin-top:10px;opacity:0.8;line-height:1.6;">
                O sistema marcar√° os dias consecutivos a partir da data selecionada.<br>
                <strong>Mais de 8 dias de falta = Dispensa M√©dica</strong>
            </small>
        </div>
    </div>
    
    <div id="camposRecorrentes" style="grid-column:1/-1;display:contents;">
    <select id="tipoEscala" onchange="ajustarCamposEscala()" required>
        <option value="">Tipo de Escala</option>
        <option value="12x24-12x72">12x24 + 12x72</option>
        <option value="12x24-12x48">12x24 + 12x48</option>
        <option value="12x24-12x96">12x24 + 12x96</option>
        <option value="diario-8h">Di√°rio 8h (Comercial)</option>
        <option value="24x48">24x48</option>
        <option value="24x72">24x72</option>
        <option value="personalizada">Personalizada</option>
    </select>
    
    <div id="camposDiaPosterior" class="oculto" style="grid-column:1/-1;">
        <div style="background:var(--info-box-bg);padding:15px;border-radius:12px;margin-top:15px;">
            <label style="display:flex;align-items:center;gap:12px;cursor:pointer;">
                <input type="checkbox" id="marcarDiaPosterior">
                <span style="font-weight:600;">‚úÖ Marcar 2 dias consecutivos</span>
            </label>
        </div>
    </div>
    
    <div id="camposPersonalizada" class="oculto" style="grid-column:1/-1;">
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:15px;margin-top:15px;">
            <input type="number" id="horasTrabalho" placeholder="Horas de trabalho" min="1">
            <input type="number" id="horasFolga" placeholder="Horas de folga" min="1">
        </div>
        <div style="background:var(--info-box-bg);padding:15px;border-radius:12px;margin-top:15px;">
            <label style="display:flex;align-items:center;gap:12px;cursor:pointer;">
                <input type="checkbox" id="incluirFinaisSemana">
                <span style="font-weight:600;">Incluir finais de semana</span>
            </label>
        </div>
    </div>
    
    <input type="date" id="dataInicioPlantonista" required>
    <input type="month" id="mesFimPlantonista" required>
    </div>
    
    <select id="turnoPlantonista">
        <option value="Diurno">Diurno</option>
        <option value="Noturno">Noturno</option>
        <option value="Manh√£">Manh√£</option>
        <option value="Tarde">Tarde</option>
        <option value="Noite">Noite</option>
        <option value="24h">24h</option>
    </select>
    <textarea id="motivoServico" placeholder="Observa√ß√£o (opcional)" style="grid-column:1/-1;resize:vertical;min-height:80px;"></textarea>
    <button type="submit" style="grid-column:1/-1;">‚ú® Gerar Escala</button>
</form>

<h3 style="margin-top:35px;margin-bottom:20px;font-size:1.3rem;">üìã Escalas Cadastradas</h3>
<div style="overflow-x:auto;">
<table>
<thead><tr><th>Nome</th><th>Fun√ß√£o</th><th>Tipo</th><th>Escala</th><th>In√≠cio</th><th>At√©</th><th>A√ß√µes</th></tr></thead>
<tbody id="listaEscalasPlantonistas"></tbody>
</table>
</div>
</div>

<div class="card">
<div class="print-header">
    <h1>üìÖ Escala de Servi√ßo</h1>
    <p id="printPeriodo"></p>
    <p>Gerado em: <span id="printData"></span></p>
</div>
<h2>üìÜ Calend√°rio</h2>
<div class="info-box no-print">
    <strong>üîç Navega√ß√£o:</strong> Use os bot√µes para navegar entre meses/anos ou busque um per√≠odo espec√≠fico abaixo.
</div>
<div class="view-controls no-print" style="border-bottom:1px solid var(--border-color);padding-bottom:20px;margin-bottom:20px;">
    <input type="date" id="dataInicioBusca" placeholder="Data in√≠cio" style="flex:1;min-width:160px;">
    <input type="date" id="dataFimBusca" placeholder="Data fim" style="flex:1;min-width:160px;">
    <button onclick="buscarPeriodo()">üîç Buscar</button>
    <button onclick="voltarHoje()">üìÖ Hoje</button>
</div>
<div class="view-controls no-print">
    <button id="btnMensal" class="active" onclick="mudarVisualizacao('mensal')">üìÖ Mensal</button>
    <button id="btnSemanal" onclick="mudarVisualizacao('semanal')">üìã Semanal</button>
    <button onclick="imprimirMes()">üñ®Ô∏è Imprimir</button>
    <button onclick="exportarPDF()">üìÑ PDF</button>
</div>

<div id="viewMensal">
    <div class="mes-navegacao">
        <button onclick="navegarMes(-1)">‚óÄ Anterior</button>
        <h3 id="mesAtual"></h3>
        <button onclick="navegarMes(1)">Pr√≥ximo ‚ñ∂</button>
    </div>
    <div id="calendario" class="calendario-mini"></div>
</div>

<div id="viewSemanal" class="oculto"></div>

<div class="legenda">
    <div class="legenda-item"><span class="legenda-cor" style="background:#10b981;"></span>Normal</div>
    <div class="legenda-item"><span class="legenda-cor" style="background:#3b82f6;"></span>Extra</div>
    <div class="legenda-item"><span class="legenda-cor" style="background:#f59e0b;"></span>Falta/Atestado</div>
    <div class="legenda-item"><span class="legenda-cor" style="background:#8b5cf6;"></span>F√©rias</div>
    <div class="legenda-item"><span class="legenda-cor" style="background:#f1f5f9;border:1px solid #ccc;"></span>Folga</div>
</div>

<div class="qr-code-container" style="display:none;" id="qrContainer">
    <p style="font-weight:600;margin-bottom:15px;">üì± Acesse pelo celular:</p>
    <div id="qrcode"></div>
    <p id="qrLink" style="font-size:11px;margin-top:15px;opacity:0.7;"></p>
</div>
</div>

<div class="card no-print">
<h2>‚ûï Escala Avulsa</h2>
<form id="formEscala">
<input type="text" id="nome" placeholder="Nome" required>
<input type="text" id="funcao" placeholder="Fun√ß√£o" required>
<input type="date" id="data" required>
<select id="turno">
    <option value="Diurno">Diurno</option>
    <option value="Noturno">Noturno</option>
    <option value="Manh√£">Manh√£</option>
    <option value="Tarde">Tarde</option>
    <option value="Noite">Noite</option>
    <option value="24h">24h</option>
</select>
<select id="tipoServicoAvulso" required>
    <option value="normal">üü¢ Normal</option>
    <option value="extra">üîµ Extra</option>
    <option value="falta">üü† Falta/Atestado</option>
    <option value="ferias">üü£ F√©rias</option>
</select>
<textarea id="motivoAvulso" placeholder="Observa√ß√£o (opcional)" style="grid-column:1/-1;resize:vertical;min-height:80px;"></textarea>
<button type="submit" style="grid-column:1/-1;">‚ú® Adicionar</button>
</form>

<h3 style="margin-top:35px;margin-bottom:20px;font-size:1.3rem;">üìã Escalas Avulsas</h3>
<div style="overflow-x:auto;">
<table>
<thead><tr><th>Nome</th><th>Fun√ß√£o</th><th>Data</th><th>Turno</th><th>Tipo</th><th>A√ß√µes</th></tr></thead>
<tbody id="listaEscala"></tbody>
</table>
</div>
</div>

<footer class="no-print">Sistema de Escala v4.0 ‚Ä¢ Google Sheets ‚Ä¢ Sincroniza√ß√£o em Tempo Real</footer>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbx_5LMRmeL7K0SwVirzwUa7Wt_bcoCcrBpaaXrNOp9E9G5ftp49o549PSSXluOB7S1FnQ/exec";
const GOOGLE_SHEETS_URL = "COLE_O_LINK_DA_SUA_PLANILHA_AQUI";
let usarGoogleSheets = (API_URL !== "COLE_SUA_URL_AQUI");
let isSyncing = false, syncInterval = null;
let escalas = [], escalasPlantonistas = [];
let mesAtualVizualizado = new Date(), visualizacaoAtual = 'mensal';
let filtrosAtivos = {nome: '', funcao: '', tipoServico: '', periodoInicio: '', periodoFim: ''};

// Fun√ß√£o para determinar prioridade de tipo de servi√ßo
function obterPrioridadeTipo(tipo) {
    const prioridades = {
        'ferias': 4,      // Maior prioridade
        'falta': 3,
        'extra': 2,
        'normal': 1
    };
    return prioridades[tipo] || 0;
}

async function carregarDadosDoSheets() {
    if (!usarGoogleSheets) { carregarDadosLocal(); return; }
    if (isSyncing) return;
    isSyncing = true;
    updateSyncStatus('Sincronizando...', 'syncing');
    try {
        const response = await fetch(`${API_URL}?action=sync&_=${Date.now()}`);
        const data = await response.json();
        if (data.success) {
            escalasPlantonistas = data.escalasPlantonistas || [];
            escalas = data.escalasAvulsas || [];
            escalasPlantonistas.forEach(e => {
                if (e.datas && e.datas.length > 0) return;
                if (e.tipoOriginal === 'nao-recorrente') return;
                if (e.tipoOriginal && e.tipoOriginal !== 'nao-recorrente') {
                    e.datas = gerarDatasEscala(e.dataInicio, e.mesAte, e.tipoOriginal, e.horasTrabalho, e.horasFolga, e.opcoes || {});
                }
            });
            renderizarTudo();
            updateSyncStatus('Sincronizado ‚òÅÔ∏è', 'success');
        }
    } catch (error) {
        console.error('Erro:', error);
        updateSyncStatus('Offline', 'error');
        carregarDadosLocal();
    } finally { isSyncing = false; }
}

async function salvarNoSheets(dados, tipo) {
    if (!usarGoogleSheets) { salvarDadosLocal(); return { success: true }; }
    updateSyncStatus('Salvando...', 'syncing');
    try {
        const formData = new FormData();
        formData.append('action', tipo);
        formData.append('data', JSON.stringify(dados));
        const response = await fetch(API_URL, { method: 'POST', body: formData });
        const result = await response.json();
        if (result.success) {
            updateSyncStatus('Salvo!', 'success');
            setTimeout(() => carregarDadosDoSheets(), 1000);
        }
        return result;
    } catch (error) {
        console.error('Erro:', error);
        salvarDadosLocal();
        return { success: false };
    }
}

async function excluirDoSheets(id, tipo, index) {
    if (!usarGoogleSheets) { salvarDadosLocal(); renderizarTudo(); return; }
    let url = `${API_URL}?action=${tipo}`;
    if (id) url += `&id=${id}`;
    if (index !== undefined) url += `&index=${index}`;
    await fetch(url);
    setTimeout(() => carregarDadosDoSheets(), 1000);
}

function updateSyncStatus(msg, status) {
    const ind = document.getElementById('syncIndicator');
    const txt = document.getElementById('syncStatus');
    const api = document.getElementById('apiStatus');
    const sheetsLink = document.getElementById('sheetsLinkHeader');
    if (ind) ind.className = 'sync-indicator ' + status;
    if (txt) txt.textContent = msg;
    if (api) {
        api.innerHTML = usarGoogleSheets ? '‚úÖ <strong>Google Sheets Conectado</strong> - Dados sincronizados' : '‚ö†Ô∏è <strong>Modo Offline</strong> - Dados no navegador';
        api.style.color = usarGoogleSheets ? '#10b981' : '#f59e0b';
    }
    if (sheetsLink && GOOGLE_SHEETS_URL !== "COLE_O_LINK_DA_SUA_PLANILHA_AQUI") {
        sheetsLink.href = GOOGLE_SHEETS_URL;
        sheetsLink.style.display = 'flex';
    }
    if (status === 'success') {
        setTimeout(() => {
            if (txt) txt.textContent = 'Sincronizado ‚òÅÔ∏è';
            if (ind) ind.className = 'sync-indicator';
        }, 2000);
    }
}

function renderizarTudo() {
    renderEscalasPlantonistas();
    renderEscala();
    atualizarVisualizacao();
    calcularEstatisticas();
    renderWidgets();
}

function renderWidgets() {
    renderWidgetMesAtual();
    renderWidgetResumo();
    renderWidgetProximos();
}

function renderWidgetMesAtual() {
    const widget = document.getElementById('widgetMesAtual');
    const hoje = new Date();
    const ano = hoje.getFullYear();
    const mes = hoje.getMonth();
    const primeiroDia = new Date(ano, mes, 1).getDay();
    const ultimoDia = new Date(ano, mes + 1, 0).getDate();
    let html = '<div class="mini-calendario">';
    ['D', 'S', 'T', 'Q', 'Q', 'S', 'S'].forEach(dia => {
        html += `<div class="mini-dia mini-header">${dia}</div>`;
    });
    for (let i = 0; i < primeiroDia; i++) {
        html += '<div class="mini-dia"></div>';
    }
    for (let dia = 1; dia <= ultimoDia; dia++) {
        const dataAtual = `${ano}-${String(mes + 1).padStart(2, '0')}-${String(dia).padStart(2, '0')}`;
        const infoServico = obterInfoServico(dataAtual);
        let className = 'mini-dia ';
        if (infoServico.temServico) {
            className += `mini-servico-${infoServico.tipo}`;
        } else {
            className += 'mini-folga';
        }
        if (dia === hoje.getDate()) {
            className += ' mini-hoje';
        }
        html += `<div class="${className}" title="${infoServico.descricao}">${dia}</div>`;
    }
    html += '</div>';
    widget.innerHTML = html;
}

function renderWidgetResumo() {
    const widget = document.getElementById('resumoMes');
    const hoje = new Date();
    const ano = hoje.getFullYear();
    const mes = hoje.getMonth();
    let normais = 0, extras = 0, faltas = 0, ferias = 0, folgas = 0;
    const ultimoDia = new Date(ano, mes + 1, 0).getDate();
    for (let dia = 1; dia <= ultimoDia; dia++) {
        const dataAtual = `${ano}-${String(mes + 1).padStart(2, '0')}-${String(dia).padStart(2, '0')}`;
        const info = obterInfoServico(dataAtual);
        if (info.temServico) {
            if (info.tipo === 'normal') normais++;
            else if (info.tipo === 'extra') extras++;
            else if (info.tipo === 'falta') faltas++;
            else if (info.tipo === 'ferias') ferias++;
        } else {
            folgas++;
        }
    }
    widget.innerHTML = `üü¢ Normais: <strong>${normais}</strong><br>üîµ Extras: <strong>${extras}</strong><br>üü† Faltas: <strong>${faltas}</strong><br>üü£ F√©rias: <strong>${ferias}</strong><br>‚ö™ Folgas: <strong>${folgas}</strong>`;
}

function renderWidgetProximos() {
    const widget = document.getElementById('widgetProximos');
    const hoje = new Date();
    hoje.setHours(0, 0, 0, 0);
    let proximosServicos = [];
    for (let i = 0; i < 30; i++) {
        const data = new Date(hoje);
        data.setDate(data.getDate() + i);
        const dataStr = data.toISOString().split('T')[0];
        const info = obterInfoServico(dataStr);
        if (info.temServico) {
            proximosServicos.push({data: dataStr, info: info});
        }
        if (proximosServicos.length >= 5) break;
    }
    if (proximosServicos.length === 0) {
        widget.innerHTML = '<em style="opacity:0.6;">Nenhum servi√ßo pr√≥ximo</em>';
        return;
    }
    let html = '';
    proximosServicos.forEach(s => {
        const [ano, mes, dia] = s.data.split('-');
        const tipoIcon = s.info.tipo === 'normal' ? 'üü¢' : s.info.tipo === 'extra' ? 'üîµ' : s.info.tipo === 'falta' ? 'üü†' : 'üü£';
        html += `${tipoIcon} ${dia}/${mes}/${ano}<br>`;
    });
    widget.innerHTML = html;
}

function aplicarFiltros() {
    filtrosAtivos = {
        nome: document.getElementById('filtroNome').value.toLowerCase().trim(),
        funcao: document.getElementById('filtroFuncao').value.toLowerCase().trim(),
        tipoServico: document.getElementById('filtroTipoServico').value,
        periodoInicio: document.getElementById('filtroPeriodoInicio').value,
        periodoFim: document.getElementById('filtroPeriodoFim').value
    };
    renderEscalasPlantonistas();
    renderEscala();
    let totalPlantonistas = escalasPlantonistas.filter(filtrarEscala).length;
    let totalAvulsas = escalas.filter(filtrarEscalaAvulsa).length;
    let total = totalPlantonistas + totalAvulsas;
    document.getElementById('resultadoFiltro').textContent = `${total} registro(s) encontrado(s)`;
}

function limparFiltros() {
    document.getElementById('filtroNome').value = '';
    document.getElementById('filtroFuncao').value = '';
    document.getElementById('filtroTipoServico').value = '';
    document.getElementById('filtroPeriodoInicio').value = '';
    document.getElementById('filtroPeriodoFim').value = '';
    document.getElementById('resultadoFiltro').textContent = '';
    filtrosAtivos = {nome: '', funcao: '', tipoServico: '', periodoInicio: '', periodoFim: ''};
    renderEscalasPlantonistas();
    renderEscala();
}

function filtrarEscala(escala) {
    if (filtrosAtivos.nome && !escala.nome.toLowerCase().includes(filtrosAtivos.nome)) return false;
    if (filtrosAtivos.funcao && !escala.funcao.toLowerCase().includes(filtrosAtivos.funcao)) return false;
    if (filtrosAtivos.tipoServico && escala.tipoServico !== filtrosAtivos.tipoServico) return false;
    if (filtrosAtivos.periodoInicio || filtrosAtivos.periodoFim) {
        const inicio = filtrosAtivos.periodoInicio || '1900-01-01';
        const fim = filtrosAtivos.periodoFim || '2100-12-31';
        if (escala.dataInicio < inicio || escala.dataInicio > fim) return false;
    }
    return true;
}

function filtrarEscalaAvulsa(escala) {
    if (filtrosAtivos.nome && !escala.nome.toLowerCase().includes(filtrosAtivos.nome)) return false;
    if (filtrosAtivos.funcao && !escala.funcao.toLowerCase().includes(filtrosAtivos.funcao)) return false;
    if (filtrosAtivos.tipoServico && escala.tipoServico !== filtrosAtivos.tipoServico) return false;
    if (filtrosAtivos.periodoInicio || filtrosAtivos.periodoFim) {
        const inicio = filtrosAtivos.periodoInicio || '1900-01-01';
        const fim = filtrosAtivos.periodoFim || '2100-12-31';
        if (escala.data < inicio || escala.data > fim) return false;
    }
    return true;
}

function exportarFiltrados() {
    const plantonistas = escalasPlantonistas.filter(filtrarEscala);
    const avulsas = escalas.filter(filtrarEscalaAvulsa);
    if (plantonistas.length === 0 && avulsas.length === 0) {
        alert('Nenhum registro encontrado com os filtros aplicados.');
        return;
    }
    let csv = 'Tipo,Nome,Fun√ß√£o,Data,Turno,Tipo Servi√ßo,Observa√ß√£o\n';
    plantonistas.forEach(e => {
        if (e.datas && Array.isArray(e.datas)) {
            e.datas.forEach(d => {
                const data = typeof d === 'object' ? d.data : d;
                const turno = typeof d === 'object' ? d.turno : e.turno;
                csv += `Recorrente,"${e.nome}","${e.funcao}","${data}","${turno}","${e.tipoServico}","${e.motivo || ''}"\n`;
            });
        }
    });
    avulsas.forEach(e => {
        csv += `Avulsa,"${e.nome}","${e.funcao}","${e.data}","${e.turno}","${e.tipoServico}","${e.motivo || ''}"\n`;
    });
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `escala-filtrada-${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
}

function imprimirMes() {
    const ano = mesAtualVizualizado.getFullYear();
    const mes = mesAtualVizualizado.getMonth();
    const nomeMes = mesAtualVizualizado.toLocaleDateString('pt-BR', {month: 'long', year: 'numeric'});
    document.getElementById('printPeriodo').textContent = nomeMes.toUpperCase();
    document.getElementById('printData').textContent = new Date().toLocaleDateString('pt-BR');
    const qrContainer = document.getElementById('qrContainer');
    const qrDiv = document.getElementById('qrcode');
    qrDiv.innerHTML = '';
    qrContainer.style.display = 'block';
    const urlAtual = window.location.href.split('?')[0];
    document.getElementById('qrLink').textContent = urlAtual;
    if (typeof QRCode !== 'undefined') {
        new QRCode(qrDiv, {text: urlAtual, width: 128, height: 128});
    }
    setTimeout(() => {
        window.print();
        qrContainer.style.display = 'none';
    }, 500);
}

function carregarDadosLocal(){
    escalas = JSON.parse(localStorage.getItem("escalas")) || [];
    escalasPlantonistas = JSON.parse(localStorage.getItem("escalasPlantonistas")) || [];
    escalasPlantonistas.forEach(e => {
        if (e.datas && e.datas.length > 0) return;
        if (e.tipoOriginal === 'nao-recorrente') return;
        if (e.tipoOriginal && e.tipoOriginal !== 'nao-recorrente') {
            e.datas = gerarDatasEscala(e.dataInicio, e.mesAte, e.tipoOriginal, e.horasTrabalho, e.horasFolga, e.opcoes || {});
        }
    });
    renderizarTudo();
}

function salvarDadosLocal(){
    if(usarGoogleSheets) return;
    localStorage.setItem("escalas", JSON.stringify(escalas));
    localStorage.setItem("escalasPlantonistas", JSON.stringify(escalasPlantonistas));
}

function toggleTheme(){
    document.body.classList.toggle('dark-mode');
    localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
}

if(localStorage.getItem('darkMode') === 'true'){
    document.body.classList.add('dark-mode');
}

function ajustarCamposTipoServico(){
    const tipoServico = document.getElementById("tipoServico").value;
    const camposExtraFalta = document.getElementById("camposExtraFalta");
    const camposRecorrentes = document.getElementById("camposRecorrentes");
    if(tipoServico === 'extra' || tipoServico === 'falta' || tipoServico === 'ferias'){
        camposExtraFalta.classList.remove("oculto");
        camposRecorrentes.style.display = "none";
        document.getElementById("tipoEscala").removeAttribute("required");
        document.getElementById("dataInicioPlantonista").removeAttribute("required");
        document.getElementById("mesFimPlantonista").removeAttribute("required");
        document.getElementById("dataUnicaServico").setAttribute("required", "required");
        document.getElementById("qtdDiasServico").setAttribute("required", "required");
    } else {
        camposExtraFalta.classList.add("oculto");
        camposRecorrentes.style.display = "contents";
        document.getElementById("tipoEscala").setAttribute("required", "required");
        document.getElementById("dataInicioPlantonista").setAttribute("required", "required");
        document.getElementById("mesFimPlantonista").setAttribute("required", "required");
        document.getElementById("dataUnicaServico").removeAttribute("required");
        document.getElementById("qtdDiasServico").removeAttribute("required");
    }
}

function ajustarCamposEscala(){
    const tipo = document.getElementById("tipoEscala").value;
    const camposPersonalizada = document.getElementById("camposPersonalizada");
    const camposDiaPosterior = document.getElementById("camposDiaPosterior");
    camposPersonalizada.classList.add("oculto");
    camposDiaPosterior.classList.add("oculto");
    if(tipo === "personalizada"){
        camposPersonalizada.classList.remove("oculto");
    }
    if(tipo === "12x24-12x72" || tipo === "12x24-12x48" || tipo === "12x24-12x96"){
        camposDiaPosterior.classList.remove("oculto");
    }
}

function gerarDatasEscala(dataInicio, mesAte, tipo, horasTrabalho, horasFolga, opcoes = {}){
    const datas = [];
    if (!tipo || tipo === 'nao-recorrente') return [];
    const inicio = new Date(dataInicio + "T00:00:00");
    const [anoFim, mesFim] = mesAte.split("-");
    const dataLimite = new Date(parseInt(anoFim), parseInt(mesFim), 0);
    let dataAtual = new Date(inicio);
    let iteracoes = 0;
    const MAX_ITERACOES = 10000;
    if(tipo === "12x24-12x72" || tipo === "12x24-12x48" || tipo === "12x24-12x96"){
        const horasFolgaFinal = tipo === "12x24-12x72" ? 72 : tipo === "12x24-12x48" ? 48 : 96;
        const marcarDiaPosterior = opcoes.marcarDiaPosterior || false;
        const diasTrabalho = marcarDiaPosterior ? 2 : 1;
        while(dataAtual <= dataLimite && iteracoes < MAX_ITERACOES){
            iteracoes++;
            for(let d = 0; d < diasTrabalho; d++){
                if(dataAtual <= dataLimite){
                    const dataStr = new Date(dataAtual).toISOString().split("T")[0];
                    datas.push({data: dataStr, turno: "Diurno"});
                    datas.push({data: dataStr, turno: "Noturno"});
                    dataAtual.setDate(dataAtual.getDate() + 1);
                }
            }
            const diasFolga = horasFolgaFinal / 24;
            dataAtual.setDate(dataAtual.getDate() + diasFolga);
        }
    }
    else if(tipo === "diario-8h"){
        while(dataAtual <= dataLimite && iteracoes < MAX_ITERACOES){
            iteracoes++;
            const diaSemana = dataAtual.getDay();
            if(diaSemana !== 0 && diaSemana !== 6){
                datas.push({data: new Date(dataAtual).toISOString().split("T")[0], turno: "08:00-16:00"});
            }
            dataAtual.setDate(dataAtual.getDate() + 1);
        }
    }
    else {
        let emServico = true;
        const incluirFinaisSemana = opcoes.incluirFinaisSemana !== undefined ? opcoes.incluirFinaisSemana : true;
        while(dataAtual <= dataLimite && iteracoes < MAX_ITERACOES){
            iteracoes++;
            const diaSemana = dataAtual.getDay();
            const ehFinalSemana = diaSemana === 0 || diaSemana === 6;
            if(emServico && (incluirFinaisSemana || !ehFinalSemana)){
                datas.push({data: new Date(dataAtual).toISOString().split("T")[0], turno: horasTrabalho === 24 ? "24h" : "Plant√£o"});
            }
            const horasAdicionar = emServico ? horasTrabalho : horasFolga;
            dataAtual.setHours(dataAtual.getHours() + horasAdicionar);
            emServico = !emServico;
        }
    }
    if(iteracoes >= MAX_ITERACOES){
        console.error("AVISO: Loop infinito detectado em gerarDatasEscala. Interrompido.");
    }
    return datas;
}

function calcularHorasEscala(tipo){
    switch(tipo){
        case "12x24-12x72": return {trabalho: 12, folga: 72};
        case "12x24-12x48": return {trabalho: 12, folga: 48};
        case "12x24-12x96": return {trabalho: 12, folga: 96};
        case "diario-8h": return {trabalho: 8, folga: 0};
        case "24x48": return {trabalho: 24, folga: 48};
        case "24x72": return {trabalho: 24, folga: 72};
        default: return null;
    }
}

document.getElementById("formEscalaPlantonista").addEventListener("submit", async (e) => {
    e.preventDefault();
    const tipoServico = document.getElementById("tipoServico").value;
    const nome = document.getElementById("nomePlantonista").value;
    const funcao = document.getElementById("funcaoPlantonista").value;
    const turno = document.getElementById("turnoPlantonista").value;
    const motivo = document.getElementById("motivoServico").value;
    
    if(tipoServico === 'extra' || tipoServico === 'falta' || tipoServico === 'ferias'){
        const dataInicio = document.getElementById("dataUnicaServico").value;
        const qtdDias = parseInt(document.getElementById("qtdDiasServico").value);
        const datas = [];
        const dataBase = new Date(dataInicio + "T00:00:00");
        for(let i = 0; i < qtdDias; i++){
            const data = new Date(dataBase);
            data.setDate(data.getDate() + i);
            datas.push({data: data.toISOString().split("T")[0], turno: turno});
        }
        const escala = {
            id: Date.now(), nome, funcao, tipoServico,
            tipoEscala: `${qtdDias} dia(s)`,
            tipoOriginal: 'nao-recorrente',
            dataInicio, mesAte: dataInicio.substring(0, 7),
            turno, motivo, qtdDias, datas
        };
        escalasPlantonistas.push(escala);
        await salvarNoSheets(escala, 'saveEscalaPlantonista');
        e.target.reset();
        ajustarCamposTipoServico();
        return;
    }
    
    const tipo = document.getElementById("tipoEscala").value;
    let horasTrabalho, horasFolga;
    let tipoEscalaDisplay = tipo;
    const opcoes = {};
    
    if(tipo === "12x24-12x72" || tipo === "12x24-12x48" || tipo === "12x24-12x96"){
        opcoes.marcarDiaPosterior = document.getElementById("marcarDiaPosterior").checked;
    }
    
    if(tipo === "personalizada"){
        horasTrabalho = parseInt(document.getElementById("horasTrabalho").value);
        horasFolga = parseInt(document.getElementById("horasFolga").value);
        tipoEscalaDisplay = `${horasTrabalho}x${horasFolga}`;
        opcoes.incluirFinaisSemana = document.getElementById("incluirFinaisSemana").checked;
    } else {
        const horas = calcularHorasEscala(tipo);
        horasTrabalho = horas.trabalho;
        horasFolga = horas.folga;
    }
    
    const escala = {
        id: Date.now(), nome, funcao, tipoServico,
        tipoEscala: tipoEscalaDisplay,
        tipoOriginal: tipo,
        dataInicio: document.getElementById("dataInicioPlantonista").value,
        mesAte: document.getElementById("mesFimPlantonista").value,
        turno, motivo, horasTrabalho, horasFolga, opcoes,
        datas: gerarDatasEscala(
            document.getElementById("dataInicioPlantonista").value,
            document.getElementById("mesFimPlantonista").value,
            tipo, horasTrabalho, horasFolga, opcoes
        )
    };
    escalasPlantonistas.push(escala);
    await salvarNoSheets(escala, 'saveEscalaPlantonista');
    e.target.reset();
    ajustarCamposEscala();
    ajustarCamposTipoServico();
});

function renderEscalasPlantonistas(){
    const lista = document.getElementById("listaEscalasPlantonistas");
    lista.innerHTML = "";
    const escalasFiltradas = escalasPlantonistas.filter(filtrarEscala);
    escalasFiltradas.forEach((e)=>{
        const [ano, mes] = e.mesAte.split("-");
        const mesFormatado = `${mes}/${ano}`;
        let tipoDisplay = e.tipoEscala;
        const tipoServicoIcon = e.tipoServico === 'normal' ? 'üü¢' : e.tipoServico === 'extra' ? 'üîµ' : e.tipoServico === 'falta' ? 'üü†' : 'üü£';
        if(e.tipoOriginal === "12x24-12x72") tipoDisplay = "12x24+12x72";
        if(e.tipoOriginal === "12x24-12x48") tipoDisplay = "12x24+12x48";
        if(e.tipoOriginal === "12x24-12x96") tipoDisplay = "12x24+12x96";
        if(e.tipoOriginal === "diario-8h") tipoDisplay = "Di√°rio 8h";
        if(e.opcoes && e.opcoes.marcarDiaPosterior) tipoDisplay += " (2d)";
        if(e.opcoes && e.opcoes.incluirFinaisSemana) tipoDisplay += " (c/FDS)";
        if(e.opcoes && e.opcoes.incluirFinaisSemana === false) tipoDisplay += " (s/FDS)";
        lista.innerHTML += `<tr><td>${e.nome}</td><td>${e.funcao}</td><td>${tipoServicoIcon}</td><td>${tipoDisplay}</td><td>${e.dataInicio.split("-").reverse().join("/")}</td><td>${mesFormatado}</td><td><button class="btn-edit" onclick="editarEscalaPlantonista(${e.id})">Editar</button><button class="btn-del" onclick="delEscalaPlantonista(${e.id})">Excluir</button></td></tr>`;
    });
}

function editarEscalaPlantonista(id){
    const escala = escalasPlantonistas.find(e => e.id === id);
    if(!escala) return;
    document.getElementById("formEscalaPlantonista").reset();
    document.getElementById("formEscalaPlantonista").scrollIntoView({ behavior: 'smooth', block: 'start' });
    document.getElementById("nomePlantonista").value = escala.nome;
    document.getElementById("funcaoPlantonista").value = escala.funcao;
    document.getElementById("tipoServico").value = escala.tipoServico;
    document.getElementById("turnoPlantonista").value = escala.turno;
    document.getElementById("motivoServico").value = escala.motivo || "";
    ajustarCamposTipoServico();
    
    setTimeout(() => {
        if(escala.tipoServico === 'extra' || escala.tipoServico === 'falta' || escala.tipoServico === 'ferias'){
            document.getElementById("dataUnicaServico").value = escala.dataInicio;
            document.getElementById("qtdDiasServico").value = escala.qtdDias || 1;
        } else {
            document.getElementById("dataInicioPlantonista").value = escala.dataInicio;
            document.getElementById("mesFimPlantonista").value = escala.mesAte;
            const tipo = escala.tipoOriginal || escala.tipoEscala;
            if(tipo && tipo !== "nao-recorrente"){
                if(tipo === "personalizada" || (!["12x24-12x72","12x24-12x48","12x24-12x96","diario-8h","24x48","24x72"].includes(tipo))){
                    document.getElementById("tipoEscala").value = "personalizada";
                    ajustarCamposEscala();
                    setTimeout(() => {
                        if(escala.horasTrabalho){
                            document.getElementById("horasTrabalho").value = escala.horasTrabalho;
                            document.getElementById("horasFolga").value = escala.horasFolga;
                        }
                        if(escala.opcoes && escala.opcoes.incluirFinaisSemana !== undefined){
                            document.getElementById("incluirFinaisSemana").checked = escala.opcoes.incluirFinaisSemana;
                        }
                    }, 50);
                } else {
                    document.getElementById("tipoEscala").value = tipo;
                    ajustarCamposEscala();
                    setTimeout(() => {
                        if(tipo === "12x24-12x72" || tipo === "12x24-12x48" || tipo === "12x24-12x96"){
                            if(escala.opcoes && escala.opcoes.marcarDiaPosterior !== undefined){
                                document.getElementById("marcarDiaPosterior").checked = escala.opcoes.marcarDiaPosterior;
                            }
                        }
                    }, 50);
                }
            }
        }
    }, 100);
    
    escalasPlantonistas = escalasPlantonistas.filter(e => e.id !== id);
    salvarDadosLocal();
    renderEscalasPlantonistas();
    atualizarVisualizacao();
    calcularEstatisticas();
}

async function delEscalaPlantonista(id){
    if(!confirm("Deseja excluir esta escala?")) return;
    escalasPlantonistas = escalasPlantonistas.filter(e => e.id !== id);
    await excluirDoSheets(id, 'deleteEscalaPlantonista');
}

function obterInfoServico(data){
    let servicos = [];
    
    // Coletar todos os servi√ßos da data
    for(let escala of escalasPlantonistas){
        if(escala.datas && Array.isArray(escala.datas)){
            for(let dia of escala.datas){
                const diaData = typeof dia === 'object' ? dia.data : dia;
                const diaTurno = typeof dia === 'object' ? dia.turno : escala.turno;
                if(diaData === data){
                    servicos.push({
                        nome: escala.nome, 
                        turno: diaTurno, 
                        tipo: escala.tipoServico, 
                        motivo: escala.motivo,
                        prioridade: obterPrioridadeTipo(escala.tipoServico)
                    });
                }
            }
        }
    }
    
    for(let escala of escalas){
        if(escala.data === data){
            servicos.push({
                nome: escala.nome, 
                turno: escala.turno, 
                tipo: escala.tipoServico, 
                motivo: escala.motivo,
                prioridade: obterPrioridadeTipo(escala.tipoServico)
            });
        }
    }
    
    if(servicos.length > 0){
        // Ordenar por prioridade (maior primeiro)
        servicos.sort((a, b) => b.prioridade - a.prioridade);
        
        // Usar o tipo de maior prioridade para a cor
        const tipoExibicao = servicos[0].tipo;
        
        let descricao = "Servi√ßo:\n";
        servicos.forEach(s => {
            const tipoLabel = s.tipo === 'normal' ? '' : s.tipo === 'extra' ? ' (EXTRA)' : s.tipo === 'falta' ? ' (FALTA)' : ' (F√âRIAS)';
            descricao += `${s.nome} - ${s.turno}${tipoLabel}`;
            if(s.motivo) descricao += ` - ${s.motivo}`;
            descricao += "\n";
        });
        
        return { temServico: true, tipo: tipoExibicao, descricao: descricao.trim() };
    }
    return { temServico: false, tipo: null, descricao: "Folga" };
}

function renderCalendario(){
    const ano = mesAtualVizualizado.getFullYear();
    const mes = mesAtualVizualizado.getMonth();
    document.getElementById("mesAtual").textContent = mesAtualVizualizado.toLocaleDateString("pt-BR", {month: "long", year: "numeric"});
    const primeiroDia = new Date(ano, mes, 1).getDay();
    const ultimoDia = new Date(ano, mes + 1, 0).getDate();
    const calendario = document.getElementById("calendario");
    calendario.innerHTML = "";
    
    ["Dom", "Seg", "Ter", "Qua", "Qui", "Sex", "S√°b"].forEach(dia => {
        const div = document.createElement("div");
        div.className = "dia-calendario dia-header";
        div.textContent = dia;
        calendario.appendChild(div);
    });
    
    for(let i = 0; i < primeiroDia; i++){
        const div = document.createElement("div");
        div.className = "dia-calendario";
        calendario.appendChild(div);
    }
    
    const hoje = new Date();
    hoje.setHours(0,0,0,0);
    
    for(let dia = 1; dia <= ultimoDia; dia++){
        const dataAtual = `${ano}-${String(mes + 1).padStart(2, "0")}-${String(dia).padStart(2, "0")}`;
        const infoServico = obterInfoServico(dataAtual);
        const dataCalendario = new Date(ano, mes, dia);
        const ehPassado = dataCalendario < hoje;
        
        const div = document.createElement("div");
        let className = "dia-calendario ";
        if(infoServico.temServico){
            className += `dia-servico-${infoServico.tipo}`;
        } else {
            className += "dia-folga";
        }
        if(ehPassado) className += " dia-passado";
        div.className = className;
        div.textContent = dia;
        div.title = infoServico.descricao;
        calendario.appendChild(div);
    }
}

function navegarMes(direcao){
    mesAtualVizualizado.setMonth(mesAtualVizualizado.getMonth() + direcao);
    renderCalendario();
    renderWidgets();
}

function renderSemanal(){
    const inicio = new Date(mesAtualVizualizado);
    inicio.setDate(inicio.getDate() - inicio.getDay());
    const viewSemanal = document.getElementById("viewSemanal");
    viewSemanal.innerHTML = `<div class="mes-navegacao"><button onclick="navegarSemana(-1)">‚óÄ Anterior</button><h3>Semana de ${inicio.toLocaleDateString("pt-BR")}</h3><button onclick="navegarSemana(1)">Pr√≥xima ‚ñ∂</button></div><div class="semana-grid" id="semanaGrid"></div>`;
    const grid = document.getElementById("semanaGrid");
    const diasSemana = ["Domingo", "Segunda", "Ter√ßa", "Quarta", "Quinta", "Sexta", "S√°bado"];
    
    for(let i = 0; i < 7; i++){
        const data = new Date(inicio);
        data.setDate(data.getDate() + i);
        const dataStr = data.toISOString().split("T")[0];
        const infoServico = obterInfoServico(dataStr);
        
        const card = document.createElement("div");
        card.className = "dia-semana-card";
        let html = `<h5>${diasSemana[i]}<br>${data.getDate()}/${data.getMonth()+1}</h5>`;
        if(infoServico.temServico){
            const servicos = infoServico.descricao.split("\n").slice(1);
            servicos.forEach(s => {
                if(s.trim()){
                    html += `<div class="servico-item servico-${infoServico.tipo}">${s}</div>`;
                }
            });
        } else {
            html += `<div style="text-align:center;padding:20px;opacity:0.5;">Folga</div>`;
        }
        card.innerHTML = html;
        grid.appendChild(card);
    }
}

function navegarSemana(direcao){
    mesAtualVizualizado.setDate(mesAtualVizualizado.getDate() + (direcao * 7));
    renderSemanal();
}

function buscarPeriodo(){
    const dataInicio = document.getElementById("dataInicioBusca").value;
    const dataFim = document.getElementById("dataFimBusca").value;
    if(!dataInicio && !dataFim){
        alert("Por favor, informe pelo menos uma data para buscar.");
        return;
    }
    if(dataInicio){
        const [ano, mes] = dataInicio.split("-");
        mesAtualVizualizado = new Date(parseInt(ano), parseInt(mes) - 1, 1);
        atualizarVisualizacao();
    }
}

function voltarHoje(){
    mesAtualVizualizado = new Date();
    document.getElementById("dataInicioBusca").value = "";
    document.getElementById("dataFimBusca").value = "";
    mudarVisualizacao('mensal');
}

function mudarVisualizacao(tipo){
    visualizacaoAtual = tipo;
    document.getElementById("btnMensal").classList.remove("active");
    document.getElementById("btnSemanal").classList.remove("active");
    document.getElementById("viewMensal").classList.add("oculto");
    document.getElementById("viewSemanal").classList.add("oculto");
    if(tipo === 'mensal'){
        document.getElementById("btnMensal").classList.add("active");
        document.getElementById("viewMensal").classList.remove("oculto");
        renderCalendario();
    } else if(tipo === 'semanal'){
        document.getElementById("btnSemanal").classList.add("active");
        document.getElementById("viewSemanal").classList.remove("oculto");
        renderSemanal();
    }
}

function atualizarVisualizacao(){
    if(visualizacaoAtual === 'mensal') renderCalendario();
    else if(visualizacaoAtual === 'semanal') renderSemanal();
}

function calcularEstatisticas(){
    let normais = 0, extras = 0, faltas = 0, dispensaMedica = 0, ferias = 0, avulsoCount = 0;
    let datasNormais = new Set(), datasExtras = new Set(), datasFaltas = new Set(), datasDispensa = new Set(), datasFerias = new Set(), datasAvulso = new Set();
    
    escalasPlantonistas.forEach(e => {
        if(e.datas && Array.isArray(e.datas)){
            e.datas.forEach(d => {
                const data = typeof d === 'object' ? d.data : d;
                if(e.tipoServico === 'normal'){
                    datasNormais.add(data);
                } else if(e.tipoServico === 'extra'){
                    datasExtras.add(data);
                } else if(e.tipoServico === 'falta'){
                    if(e.datas.length > 8){
                        datasDispensa.add(data);
                    } else {
                        datasFaltas.add(data);
                    }
                } else if(e.tipoServico === 'ferias'){
                    datasFerias.add(data);
                }
            });
        }
    });
    
    escalas.forEach(e => {
        avulsoCount++;
        datasAvulso.add(e.data);
        if(e.tipoServico === 'normal') datasNormais.add(e.data);
        else if(e.tipoServico === 'extra') datasExtras.add(e.data);
        else if(e.tipoServico === 'falta') datasFaltas.add(e.data);
        else if(e.tipoServico === 'ferias') datasFerias.add(e.data);
    });
    
    normais = datasNormais.size;
    extras = datasExtras.size;
    faltas = datasFaltas.size;
    dispensaMedica = datasDispensa.size;
    ferias = datasFerias.size;
    const avulsoDias = datasAvulso.size;
    
    let totalFolgas = 0, totalDiasPeriodo = 0;
    let todasDatas = new Set([...datasNormais, ...datasExtras, ...datasFaltas, ...datasDispensa, ...datasFerias, ...datasAvulso]);
    
    if(todasDatas.size > 0){
        const datasArray = Array.from(todasDatas).sort();
        const primeiraData = datasArray[0];
        const ultimaData = datasArray[datasArray.length - 1];
        const dataMinima = new Date(primeiraData + 'T00:00:00');
        const dataMaxima = new Date(ultimaData + 'T00:00:00');
        const diffTime = dataMaxima.getTime() - dataMinima.getTime();
        totalDiasPeriodo = Math.floor(diffTime / (1000 * 60 * 60 * 24)) + 1;
        const diasTrabalhados = normais + extras + avulsoDias + dispensaMedica + ferias;
        totalFolgas = totalDiasPeriodo - diasTrabalhados;
        if(totalFolgas < 0) totalFolgas = 0;
    }
    
    document.getElementById("statNormais").textContent = normais;
    document.getElementById("statExtras").textContent = extras;
    document.getElementById("statFaltas").textContent = faltas;
    document.getElementById("statDispensa").textContent = dispensaMedica;
    document.getElementById("statFerias").textContent = ferias;
    document.getElementById("statAvulso").textContent = avulsoCount;
    document.getElementById("statFolgas").textContent = totalFolgas;
    document.getElementById("statTotal").textContent = normais + extras + faltas + dispensaMedica + ferias;
}

async function exportarPDF(){
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('p', 'mm', 'a4');
    const elemento = document.querySelector('.card');
    const canvas = await html2canvas(elemento, {scale: 2, backgroundColor: '#ffffff'});
    const imgData = canvas.toDataURL('image/png');
    const imgWidth = 190;
    const imgHeight = (canvas.height * imgWidth) / canvas.width;
    pdf.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeight);
    pdf.save('escala-servico.pdf');
}

function renderEscala(){
    const lista = document.getElementById("listaEscala");
    lista.innerHTML = "";
    const escalasFiltradas = escalas.filter(filtrarEscalaAvulsa);
    escalasFiltradas.forEach((e,i)=>{
        const tipoIcon = e.tipoServico === 'normal' ? 'üü¢' : e.tipoServico === 'extra' ? 'üîµ' : e.tipoServico === 'falta' ? 'üü†' : 'üü£';
        const indexOriginal = escalas.indexOf(e);
        lista.innerHTML += `<tr><td>${e.nome}</td><td>${e.funcao}</td><td>${e.data.split("-").reverse().join("/")}</td><td>${e.turno}</td><td>${tipoIcon}</td><td><button class="btn-edit" onclick="editarEscala(${indexOriginal})">Editar</button><button class="btn-del" onclick="delEscala(${indexOriginal})">Excluir</button></td></tr>`;
    });
}

function editarEscala(i){
    const e = escalas[i];
    document.getElementById("formEscala").reset();
    document.getElementById("formEscala").scrollIntoView({ behavior: 'smooth', block: 'start' });
    document.getElementById("nome").value = e.nome;
    document.getElementById("funcao").value = e.funcao;
    document.getElementById("data").value = e.data;
    document.getElementById("turno").value = e.turno;
    document.getElementById("tipoServicoAvulso").value = e.tipoServico;
    document.getElementById("motivoAvulso").value = e.motivo || "";
    escalas.splice(i, 1);
    salvarDadosLocal();
    renderEscala();
    atualizarVisualizacao();
    calcularEstatisticas();
}

document.getElementById("formEscala").addEventListener("submit", async (e) => {
    e.preventDefault();
    const escala = {
        nome: nome.value, 
        funcao: funcao.value, 
        data: data.value, 
        turno: turno.value, 
        tipoServico: tipoServicoAvulso.value, 
        motivo: motivoAvulso.value
    };
    escalas.push(escala);
    await salvarNoSheets(escala, 'saveEscalaAvulsa');
    e.target.reset();
});

async function delEscala(i){
    if(!confirm("Deseja excluir esta escala?")) return;
    escalas.splice(i,1);
    await excluirDoSheets(null, 'deleteEscalaAvulsa', i);
}

window.addEventListener('DOMContentLoaded', () => {
    if (usarGoogleSheets) {
        carregarDadosDoSheets();
        syncInterval = setInterval(() => {
            if (!isSyncing) carregarDadosDoSheets();
        }, 5000);
    } else {
        carregarDadosLocal();
    }
    updateSyncStatus('Pronto', 'success');
});

window.addEventListener('beforeunload', () => {
    if (syncInterval) clearInterval(syncInterval);
});
</script>
</body>
</html>
