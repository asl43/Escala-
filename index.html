<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Sistema de Escala de Servi√ßo - Google Sheets v4.0</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700;800&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
<style>
:root {
    /* Gradientes Modernos */
    --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --bg-gradient-alt: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    --card-gradient: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
    
    /* Cores Principais */
    --primary: #667eea;
    --primary-dark: #5568d3;
    --secondary: #764ba2;
    --accent: #f5576c;
    --success: #4ade80;
    --warning: #fbbf24;
    --danger: #f87171;
    --info: #60a5fa;
    
    /* Backgrounds */
    --bg-main: #0f0f23;
    --bg-card: rgba(255, 255, 255, 0.08);
    --bg-card-hover: rgba(255, 255, 255, 0.12);
    
    /* Textos */
    --text-primary: #ffffff;
    --text-secondary: rgba(255, 255, 255, 0.7);
    --text-tertiary: rgba(255, 255, 255, 0.5);
    
    /* Borders */
    --border-color: rgba(255, 255, 255, 0.1);
    --border-hover: rgba(255, 255, 255, 0.3);
    
    /* Sombras */
    --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.1);
    --shadow-md: 0 4px 20px rgba(0, 0, 0, 0.15);
    --shadow-lg: 0 10px 40px rgba(0, 0, 0, 0.2);
    --shadow-xl: 0 20px 60px rgba(0, 0, 0, 0.3);
    
    /* Glass Effect */
    --glass-bg: rgba(255, 255, 255, 0.05);
    --glass-border: rgba(255, 255, 255, 0.1);
}

body.dark-mode {
    --bg-main: #0a0a0f;
    --bg-card: rgba(255, 255, 255, 0.03);
    --bg-card-hover: rgba(255, 255, 255, 0.08);
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Outfit', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    background: var(--bg-main);
    color: var(--text-primary);
    min-height: 100vh;
    line-height: 1.6;
    overflow-x: hidden;
    position: relative;
}

/* Background Animado */
body::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: var(--bg-gradient);
    opacity: 0.03;
    z-index: -1;
    animation: gradientShift 15s ease infinite;
}

@keyframes gradientShift {
    0%, 100% { transform: translateY(0) scale(1); }
    50% { transform: translateY(-20px) scale(1.05); }
}

/* Part√≠culas Flutuantes */
body::after {
    content: '';
    position: fixed;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background-image: 
        radial-gradient(circle, rgba(102, 126, 234, 0.05) 1px, transparent 1px),
        radial-gradient(circle, rgba(118, 75, 162, 0.05) 1px, transparent 1px);
    background-size: 50px 50px, 80px 80px;
    background-position: 0 0, 25px 25px;
    animation: particlesFloat 60s linear infinite;
    z-index: -1;
    pointer-events: none;
}

@keyframes particlesFloat {
    0% { transform: translate(0, 0); }
    100% { transform: translate(50px, 50px); }
}

.container {
    max-width: 1800px;
    margin: 0 auto;
    padding: 40px 20px;
    animation: fadeInUp 0.8s ease-out;
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Header Controls - Glass Morphism */
.header-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 40px;
    padding: 25px 35px;
    background: var(--glass-bg);
    backdrop-filter: blur(20px) saturate(180%);
    -webkit-backdrop-filter: blur(20px) saturate(180%);
    border-radius: 24px;
    border: 1px solid var(--glass-border);
    gap: 20px;
    flex-wrap: wrap;
    position: relative;
    overflow: hidden;
    box-shadow: var(--shadow-lg);
    animation: slideDown 0.6s ease-out;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.header-controls::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
    animation: shimmer 3s infinite;
}

@keyframes shimmer {
    0% { left: -100%; }
    100% { left: 100%; }
}

h1 {
    font-size: 2.8rem;
    font-weight: 800;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f5576c 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    letter-spacing: -1.5px;
    margin: 0;
    text-shadow: 0 0 40px rgba(102, 126, 234, 0.3);
    animation: titleGlow 3s ease-in-out infinite;
    position: relative;
    display: inline-block;
}

@keyframes titleGlow {
    0%, 100% {
        filter: brightness(1);
        text-shadow: 0 0 20px rgba(102, 126, 234, 0.3);
    }
    50% {
        filter: brightness(1.2);
        text-shadow: 0 0 40px rgba(102, 126, 234, 0.5);
    }
}

/* Bot√µes Modernos */
.sheets-link, .sync-badge, .theme-toggle, button, .btn-filtro {
    background: var(--glass-bg);
    backdrop-filter: blur(10px);
    border: 1px solid var(--glass-border);
    padding: 12px 28px;
    border-radius: 16px;
    color: var(--text-primary);
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: var(--shadow-sm);
    font-family: 'Outfit', sans-serif;
    font-size: 14px;
    position: relative;
    overflow: hidden;
}

.sheets-link::before, .theme-toggle::before, button::before, .btn-filtro::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.2);
    transform: translate(-50%, -50%);
    transition: width 0.6s, height 0.6s;
}

.sheets-link:hover::before, .theme-toggle:hover::before, button:hover::before, .btn-filtro:hover::before {
    width: 300px;
    height: 300px;
}

.sheets-link:hover, .theme-toggle:hover, button:hover, .btn-filtro:hover {
    transform: translateY(-3px) scale(1.02);
    box-shadow: var(--shadow-md);
    border-color: var(--border-hover);
    background: var(--bg-card-hover);
}

.sheets-link {
    display: flex;
    align-items: center;
    gap: 10px;
    text-decoration: none;
}

/* Sync Badge - Pulsante */
.sync-badge {
    display: flex;
    align-items: center;
    gap: 12px;
    animation: pulse 2s ease-in-out infinite;
}

@keyframes pulse {
    0%, 100% {
        box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.4);
    }
    50% {
        box-shadow: 0 0 0 10px rgba(102, 126, 234, 0);
    }
}

.sync-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: var(--success);
    box-shadow: 0 0 20px currentColor;
    animation: breathe 2s ease-in-out infinite;
}

@keyframes breathe {
    0%, 100% {
        transform: scale(1);
        opacity: 1;
    }
    50% {
        transform: scale(1.3);
        opacity: 0.7;
    }
}

.sync-indicator.syncing {
    background: var(--info);
    animation: spin 1s linear infinite, breathe 2s ease-in-out infinite;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

.sync-indicator.error {
    background: var(--danger);
}

/* Cards Premium */
.card {
    background: var(--glass-bg);
    backdrop-filter: blur(20px) saturate(180%);
    border-radius: 28px;
    padding: 40px;
    margin-bottom: 30px;
    border: 1px solid var(--glass-border);
    box-shadow: var(--shadow-lg);
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
    animation: cardFadeIn 0.6s ease-out backwards;
}

@keyframes cardFadeIn {
    from {
        opacity: 0;
        transform: translateY(20px) scale(0.95);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

.card:nth-child(1) { animation-delay: 0.1s; }
.card:nth-child(2) { animation-delay: 0.2s; }
.card:nth-child(3) { animation-delay: 0.3s; }
.card:nth-child(4) { animation-delay: 0.4s; }

.card::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle, rgba(102, 126, 234, 0.1) 0%, transparent 70%);
    opacity: 0;
    transition: opacity 0.4s;
    pointer-events: none;
}

.card:hover::before {
    opacity: 1;
}

.card:hover {
    transform: translateY(-8px) scale(1.01);
    box-shadow: var(--shadow-xl);
    border-color: rgba(102, 126, 234, 0.3);
}

.card h2 {
    font-size: 2rem;
    font-weight: 700;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin: 0 0 30px 0;
    letter-spacing: -0.5px;
    position: relative;
    display: inline-block;
}

.card h2::after {
    content: '';
    position: absolute;
    bottom: -10px;
    left: 0;
    width: 60px;
    height: 4px;
    background: linear-gradient(90deg, var(--primary) 0%, var(--secondary) 100%);
    border-radius: 2px;
    box-shadow: 0 0 10px var(--primary);
}

/* Widgets Grid */
.widgets-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 25px;
    margin-bottom: 30px;
}

.widget {
    background: var(--glass-bg);
    backdrop-filter: blur(10px);
    border-radius: 24px;
    padding: 28px;
    border: 1px solid var(--glass-border);
    box-shadow: var(--shadow-md);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
}

.widget::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 4px;
    background: linear-gradient(90deg, var(--primary) 0%, var(--secondary) 50%, var(--accent) 100%);
    transform: scaleX(0);
    transform-origin: left;
    transition: transform 0.5s ease;
}

.widget:hover::before {
    transform: scaleX(1);
}

.widget:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-lg);
    border-color: var(--border-hover);
}

.widget h3 {
    font-size: 1.2rem;
    font-weight: 700;
    color: var(--text-primary);
    margin: 0 0 20px 0;
    padding-bottom: 15px;
    border-bottom: 2px solid var(--border-color);
}

/* Stats Cards - 3D Effect */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 25px;
    margin-top: 30px;
}

.stat-card {
    background: var(--glass-bg);
    backdrop-filter: blur(10px);
    padding: 35px 25px;
    border-radius: 20px;
    border: 1px solid var(--glass-border);
    text-align: center;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
    cursor: pointer;
}

.stat-card::before {
    content: '';
    position: absolute;
    top: -100%;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(180deg, transparent, rgba(102, 126, 234, 0.1));
    transition: top 0.4s;
}

.stat-card:hover::before {
    top: 0;
}

.stat-card:hover {
    transform: translateY(-10px) rotateX(5deg);
    box-shadow: 0 20px 50px rgba(102, 126, 234, 0.3);
    border-color: var(--primary);
}

.stat-number {
    font-size: 3.5rem;
    font-weight: 800;
    background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin: 15px 0;
    font-family: 'Space Mono', monospace;
    text-shadow: 0 0 30px rgba(102, 126, 234, 0.5);
    animation: numberPop 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
}

@keyframes numberPop {
    0% {
        transform: scale(0);
        opacity: 0;
    }
    50% {
        transform: scale(1.2);
    }
    100% {
        transform: scale(1);
        opacity: 1;
    }
}

.stat-label {
    font-size: 13px;
    color: var(--text-secondary);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1.2px;
}

/* Calend√°rio Moderno */
.calendario-mini {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 10px;
    margin-top: 25px;
}

.dia-calendario {
    aspect-ratio: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    border-radius: 16px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
    border: 1px solid var(--border-color);
    background: var(--glass-bg);
    backdrop-filter: blur(5px);
}

.dia-calendario::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.2);
    transform: translate(-50%, -50%);
    transition: width 0.4s, height 0.4s;
}

.dia-calendario:hover::before {
    width: 100%;
    height: 100%;
}

.dia-calendario:hover:not(.dia-header) {
    transform: scale(1.15) translateY(-5px);
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    z-index: 10;
}

.dia-header {
    background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
    color: white;
    font-weight: 700;
    text-transform: uppercase;
    font-size: 11px;
    letter-spacing: 1px;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
}

.dia-servico-normal {
    background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
    color: white;
    box-shadow: 0 4px 15px rgba(74, 222, 128, 0.4);
}

.dia-servico-extra {
    background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
    color: white;
    box-shadow: 0 4px 15px rgba(96, 165, 250, 0.4);
}

.dia-servico-falta {
    background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
    color: white;
    box-shadow: 0 4px 15px rgba(251, 191, 36, 0.4);
}

.dia-servico-ferias {
    background: linear-gradient(135deg, #a78bfa 0%, #8b5cf6 100%);
    color: white;
    box-shadow: 0 4px 15px rgba(167, 139, 250, 0.4);
}

.dia-folga {
    background: rgba(255, 255, 255, 0.03);
    color: var(--text-tertiary);
    border: 1px dashed var(--border-color);
}

.dia-hoje {
    border: 3px solid var(--accent) !important;
    box-shadow: 0 0 30px rgba(245, 87, 108, 0.6) !important;
    animation: todayPulse 2s ease-in-out infinite;
}

@keyframes todayPulse {
    0%, 100% {
        box-shadow: 0 0 20px rgba(245, 87, 108, 0.4);
    }
    50% {
        box-shadow: 0 0 40px rgba(245, 87, 108, 0.8);
    }
}

.dia-passado {
    opacity: 0.4;
    filter: grayscale(50%);
}

/* Mini Calend√°rio (Widget) */
.mini-calendario {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 6px;
}

.mini-dia {
    aspect-ratio: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    font-weight: 600;
    border-radius: 10px;
    transition: all 0.2s;
    cursor: pointer;
    border: 1px solid transparent;
}

.mini-dia:hover:not(.mini-header) {
    transform: scale(1.2);
    z-index: 10;
}

.mini-header {
    background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
    color: white;
    font-weight: 700;
    font-size: 9px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.mini-servico-normal {
    background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
    color: white;
}

.mini-servico-extra {
    background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
    color: white;
}

.mini-servico-falta {
    background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
    color: white;
}

.mini-servico-ferias {
    background: linear-gradient(135deg, #a78bfa 0%, #8b5cf6 100%);
    color: white;
}

.mini-folga {
    background: rgba(255, 255, 255, 0.05);
    color: var(--text-tertiary);
}

.mini-hoje {
    border: 2px solid var(--accent);
    box-shadow: 0 0 15px rgba(245, 87, 108, 0.5);
}

/* Formul√°rios Modernos */
form {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 18px;
    margin-bottom: 25px;
}

input, select, textarea {
    padding: 16px 20px;
    border-radius: 14px;
    border: 1px solid var(--border-color);
    background: rgba(255, 255, 255, 0.05);
    color: var(--text-primary);
    font-family: 'Outfit', sans-serif;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.3s;
    backdrop-filter: blur(5px);
}

input::placeholder, select::placeholder, textarea::placeholder {
    color: var(--text-tertiary);
}

input:focus, select:focus, textarea:focus {
    outline: none;
    border-color: var(--primary);
    background: rgba(102, 126, 234, 0.1);
    box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
    transform: translateY(-2px);
}

/* Bot√µes de A√ß√£o */
.btn-edit {
    background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 12px;
    font-weight: 600;
    font-size: 13px;
    cursor: pointer;
    transition: all 0.3s;
    box-shadow: 0 4px 15px rgba(74, 222, 128, 0.3);
}

.btn-edit:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 20px rgba(74, 222, 128, 0.5);
}

.btn-del {
    background: linear-gradient(135deg, #f87171 0%, #ef4444 100%);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 12px;
    font-weight: 600;
    font-size: 13px;
    cursor: pointer;
    transition: all 0.3s;
    box-shadow: 0 4px 15px rgba(248, 113, 113, 0.3);
}

.btn-del:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 20px rgba(248, 113, 113, 0.5);
}

/* Tabelas Modernas */
table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    margin-top: 25px;
    border-radius: 16px;
    overflow: hidden;
    box-shadow: var(--shadow-md);
}

th, td {
    padding: 16px 14px;
    text-align: center;
    font-size: 14px;
    border-bottom: 1px solid var(--border-color);
}

th {
    background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
    color: white;
    font-weight: 700;
    text-transform: uppercase;
    font-size: 12px;
    letter-spacing: 1px;
    position: sticky;
    top: 0;
    z-index: 10;
}

tbody tr {
    background: var(--glass-bg);
    backdrop-filter: blur(10px);
    transition: all 0.3s;
}

tbody tr:hover {
    background: var(--bg-card-hover);
    transform: scale(1.01);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
}

/* Info Box */
.info-box {
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
    border: 1px solid rgba(102, 126, 234, 0.3);
    padding: 22px;
    border-radius: 16px;
    margin-bottom: 25px;
    font-size: 14px;
    line-height: 1.8;
    backdrop-filter: blur(10px);
}

/* Legenda Moderna */
.legenda {
    margin-top: 30px;
    display: flex;
    gap: 25px;
    justify-content: center;
    font-size: 13px;
    flex-wrap: wrap;
    padding: 25px;
    background: var(--glass-bg);
    backdrop-filter: blur(10px);
    border-radius: 16px;
    border: 1px solid var(--border-color);
}

.legenda-item {
    display: flex;
    align-items: center;
    gap: 12px;
    font-weight: 600;
    transition: transform 0.2s;
    cursor: pointer;
}

.legenda-item:hover {
    transform: scale(1.1);
}

.legenda-cor {
    width: 28px;
    height: 28px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    transition: transform 0.3s;
}

.legenda-item:hover .legenda-cor {
    transform: rotate(360deg);
}

/* Navega√ß√£o de M√™s */
.mes-navegacao {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    gap: 20px;
    flex-wrap: wrap;
}

.mes-navegacao button {
    padding: 14px 28px;
    font-weight: 600;
    background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
    color: white;
    border: none;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
}

.mes-navegacao h3 {
    font-size: 1.8rem;
    font-weight: 700;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

/* View Controls */
.view-controls {
    display: flex;
    gap: 15px;
    margin-bottom: 30px;
    flex-wrap: wrap;
}

.view-controls button, .view-controls select, .view-controls input {
    padding: 14px 26px;
    flex: 1;
    min-width: 150px;
    font-weight: 600;
}

.view-controls button.active {
    background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
    color: white;
    box-shadow: 0 4px 20px rgba(74, 222, 128, 0.4);
    transform: scale(1.05);
}

/* Filtros Avan√ßados */
.filtros-avancados {
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
    padding: 30px;
    border-radius: 20px;
    margin-bottom: 30px;
    border: 1px solid var(--border-color);
    backdrop-filter: blur(10px);
}

.filtro-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 18px;
    margin-bottom: 25px;
}

.filtro-actions {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
    align-items: center;
}

.btn-limpar {
    background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
    color: white;
    box-shadow: 0 4px 15px rgba(251, 191, 36, 0.3);
}

/* Footer */
footer {
    text-align: center;
    color: var(--text-secondary);
    margin-top: 60px;
    font-size: 14px;
    font-weight: 500;
    padding: 30px;
    background: var(--glass-bg);
    backdrop-filter: blur(10px);
    border-radius: 16px;
    border: 1px solid var(--border-color);
}

/* Responsivo */
@media (max-width: 768px) {
    h1 {
        font-size: 2rem;
    }
    
    .header-controls {
        padding: 20px;
    }
    
    .calendario-mini {
        gap: 6px;
    }
    
    .dia-calendario {
        font-size: 12px;
    }
    
    .widgets-container {
        grid-template-columns: 1fr;
    }
    
    .stats-grid {
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    }
    
    .stat-number {
        font-size: 2.5rem;
    }
}

/* Loading Animation */
@keyframes loading {
    0% {
        transform: rotate(0deg);
    }
    100% {
        transform: rotate(360deg);
    }
}

.loading {
    width: 40px;
    height: 40px;
    border: 4px solid rgba(255, 255, 255, 0.1);
    border-top-color: var(--primary);
    border-radius: 50%;
    animation: loading 1s linear infinite;
}

/* Scrollbar Personalizada */
::-webkit-scrollbar {
    width: 12px;
}

::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.05);
}

::-webkit-scrollbar-thumb {
    background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
    border-radius: 6px;
}

::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(135deg, var(--primary-dark) 0%, var(--secondary) 100%);
}

/* Efeito Glass nos Inputs */
input, select, textarea {
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
}

/* Sele√ß√£o de Texto */
::selection {
    background: rgba(102, 126, 234, 0.3);
    color: white;
}

::-moz-selection {
    background: rgba(102, 126, 234, 0.3);
    color: white;
}

/* Print Styles */
@media print {
    .no-print {
        display: none !important;
    }
    
    body {
        background: white;
        color: black;
    }
    
    .card {
        box-shadow: none;
        border: 1px solid #ccc;
        page-break-inside: avoid;
    }
}

/* Oculto */
.oculto {
    display: none;
}
</style>
</style>
</head>
<body>
<div class="container">
<div class="header-controls no-print">
<h1>üìÖ Sistema de Escala v4.0</h1>
<div style="display:flex;gap:15px;align-items:center;flex-wrap:wrap;">
    <a href="#" id="sheetsLinkHeader" class="sheets-link" target="_blank" style="display:none;">
        üìä Abrir Google Sheets
    </a>
    <div class="sync-badge">
        <div class="sync-indicator" id="syncIndicator"></div>
        <span id="syncStatus">Sincronizado ‚òÅÔ∏è</span>
    </div>
    <button class="theme-toggle" onclick="toggleTheme()">üåì Tema</button>
</div>
</div>

<div class="card no-print">
<div class="info-box" style="text-align:center;">
    <span id="apiStatus">‚òÅÔ∏è <strong>Conectado ao Google Sheets</strong> - Sincroniza√ß√£o autom√°tica a cada 5 segundos</span>
</div>
</div>

<div class="widgets-container no-print">
    <div class="widget">
        <h3>üìÖ M√™s Atual</h3>
        <div id="widgetMesAtual"></div>
    </div>
    <div class="widget">
        <h3>üìä Resumo R√°pido</h3>
        <div id="widgetResumo" style="padding:10px;">
            <div style="margin:5px 0;"><strong>Este m√™s:</strong></div>
            <div id="resumoMes" style="font-size:13px;line-height:2;"></div>
        </div>
    </div>
    <div class="widget">
        <h3>üîî Pr√≥ximos Servi√ßos</h3>
        <div id="widgetProximos" style="font-size:13px;line-height:2;padding:10px;"></div>
    </div>
</div>

<div class="card no-print">
<h2>üîç Filtros Avan√ßados</h2>
<div class="filtros-avancados">
    <div class="filtro-grid">
        <input type="text" id="filtroNome" placeholder="üîç Buscar por nome">
        <input type="text" id="filtroFuncao" placeholder="üîç Buscar por fun√ß√£o">
        <select id="filtroTipoServico">
            <option value="">Todos os tipos</option>
            <option value="normal">üü¢ Servi√ßo Normal</option>
            <option value="extra">üîµ Servi√ßo Extra</option>
            <option value="falta">üü† Falta/Atestado</option>
            <option value="ferias">üü£ F√©rias</option>
        </select>
        <input type="date" id="filtroPeriodoInicio" placeholder="Per√≠odo in√≠cio">
        <input type="date" id="filtroPeriodoFim" placeholder="Per√≠odo fim">
    </div>
    <div class="filtro-actions">
        <button class="btn-filtro" onclick="aplicarFiltros()">üîç Aplicar</button>
        <button class="btn-filtro btn-limpar" onclick="limparFiltros()">üóëÔ∏è Limpar</button>
        <button class="btn-filtro" onclick="exportarFiltrados()">üìÑ Exportar</button>
        <span id="resultadoFiltro" style="padding:8px;color:var(--text-color);font-weight:bold;"></span>
    </div>
</div>
</div>

<div class="card">
<h2>üìä Estat√≠sticas</h2>
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-label">Servi√ßos Normais</div>
        <div class="stat-number" id="statNormais">0</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Servi√ßos Extras</div>
        <div class="stat-number" id="statExtras">0</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Faltas/Atestados</div>
        <div class="stat-number" id="statFaltas">0</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Dispensa M√©dica</div>
        <div class="stat-number" id="statDispensa">0</div>
        <small style="font-size:11px;opacity:0.7;">(Acima de 8 dias)</small>
    </div>
    <div class="stat-card">
        <div class="stat-label">F√©rias</div>
        <div class="stat-number" id="statFerias">0</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Avulso/Permuta</div>
        <div class="stat-number" id="statAvulso">0</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Total de Folgas</div>
        <div class="stat-number" id="statFolgas">0</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Dias Trabalhados</div>
        <div class="stat-number" id="statTotal">0</div>
    </div>
</div>
</div>

<div class="card no-print">
<h2>üîÑ Escala Recorrente</h2>
<div class="info-box">
    <strong>üí° Dica:</strong> Configure escalas que se repetem automaticamente. Agora com suporte para <strong>f√©rias</strong>!
</div>
<form id="formEscalaPlantonista">
    <input type="text" id="nomePlantonista" placeholder="Nome" required>
    <input type="text" id="funcaoPlantonista" placeholder="Fun√ß√£o" required>
    <select id="tipoServico" required onchange="ajustarCamposTipoServico()">
        <option value="">Tipo de Servi√ßo</option>
        <option value="normal">üü¢ Servi√ßo Normal</option>
        <option value="extra">üîµ Servi√ßo Extra</option>
        <option value="falta">üü† Falta/Atestado</option>
        <option value="ferias">üü£ F√©rias</option>
    </select>
    
    <div id="camposExtraFalta" class="oculto" style="grid-column:1/-1;">
        <div style="background:var(--info-box-bg);padding:20px;border-radius:12px;margin-top:15px;">
            <p style="margin:0 0 15px 0;font-weight:bold;">‚ö†Ô∏è Configura√ß√£o de Servi√ßo √önico</p>
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:15px;">
                <input type="date" id="dataUnicaServico" placeholder="Data inicial">
                <input type="number" id="qtdDiasServico" placeholder="Quantidade de dias" min="1" max="365">
            </div>
            <small style="display:block;margin-top:10px;opacity:0.8;line-height:1.6;">
                O sistema marcar√° os dias consecutivos a partir da data selecionada.<br>
                <strong>Mais de 8 dias de falta = Dispensa M√©dica</strong>
            </small>
        </div>
    </div>
    
    <div id="camposRecorrentes" style="grid-column:1/-1;display:contents;">
    <select id="tipoEscala" onchange="ajustarCamposEscala()" required>
        <option value="">Tipo de Escala</option>
        <option value="12x24-12x72">12x24 + 12x72</option>
        <option value="12x24-12x48">12x24 + 12x48</option>
        <option value="12x24-12x96">12x24 + 12x96</option>
        <option value="diario-8h">Di√°rio 8h (Comercial)</option>
        <option value="24x48">24x48</option>
        <option value="24x72">24x72</option>
        <option value="personalizada">Personalizada</option>
    </select>
    
    <div id="camposDiaPosterior" class="oculto" style="grid-column:1/-1;">
        <div style="background:var(--info-box-bg);padding:15px;border-radius:12px;margin-top:15px;">
            <label style="display:flex;align-items:center;gap:12px;cursor:pointer;">
                <input type="checkbox" id="marcarDiaPosterior">
                <span style="font-weight:600;">‚úÖ Marcar 2 dias consecutivos</span>
            </label>
        </div>
    </div>
    
    <div id="camposPersonalizada" class="oculto" style="grid-column:1/-1;">
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:15px;margin-top:15px;">
            <input type="number" id="horasTrabalho" placeholder="Horas de trabalho" min="1">
            <input type="number" id="horasFolga" placeholder="Horas de folga" min="1">
        </div>
        <div style="background:var(--info-box-bg);padding:15px;border-radius:12px;margin-top:15px;">
            <label style="display:flex;align-items:center;gap:12px;cursor:pointer;">
                <input type="checkbox" id="incluirFinaisSemana">
                <span style="font-weight:600;">Incluir finais de semana</span>
            </label>
        </div>
    </div>
    
    <input type="date" id="dataInicioPlantonista" required>
    <input type="month" id="mesFimPlantonista" required>
    </div>
    
    <select id="turnoPlantonista">
        <option value="Diurno">Diurno</option>
        <option value="Noturno">Noturno</option>
        <option value="Manh√£">Manh√£</option>
        <option value="Tarde">Tarde</option>
        <option value="Noite">Noite</option>
        <option value="24h">24h</option>
    </select>
    <textarea id="motivoServico" placeholder="Observa√ß√£o (opcional)" style="grid-column:1/-1;resize:vertical;min-height:80px;"></textarea>
    <button type="submit" style="grid-column:1/-1;">‚ú® Gerar Escala</button>
</form>

<h3 style="margin-top:35px;margin-bottom:20px;font-size:1.3rem;">üìã Escalas Cadastradas</h3>
<div style="overflow-x:auto;">
<table>
<thead><tr><th>Nome</th><th>Fun√ß√£o</th><th>Tipo</th><th>Escala</th><th>In√≠cio</th><th>At√©</th><th>A√ß√µes</th></tr></thead>
<tbody id="listaEscalasPlantonistas"></tbody>
</table>
</div>
</div>

<div class="card">
<div class="print-header">
    <h1>üìÖ Escala de Servi√ßo</h1>
    <p id="printPeriodo"></p>
    <p>Gerado em: <span id="printData"></span></p>
</div>
<h2>üìÜ Calend√°rio</h2>
<div class="info-box no-print">
    <strong>üîç Navega√ß√£o:</strong> Use os bot√µes para navegar entre meses/anos ou busque um per√≠odo espec√≠fico abaixo.
</div>
<div class="view-controls no-print" style="border-bottom:1px solid var(--border-color);padding-bottom:20px;margin-bottom:20px;">
    <input type="date" id="dataInicioBusca" placeholder="Data in√≠cio" style="flex:1;min-width:160px;">
    <input type="date" id="dataFimBusca" placeholder="Data fim" style="flex:1;min-width:160px;">
    <button onclick="buscarPeriodo()">üîç Buscar</button>
    <button onclick="voltarHoje()">üìÖ Hoje</button>
</div>
<div class="view-controls no-print">
    <button id="btnMensal" class="active" onclick="mudarVisualizacao('mensal')">üìÖ Mensal</button>
    <button id="btnSemanal" onclick="mudarVisualizacao('semanal')">üìã Semanal</button>
    <button onclick="imprimirMes()">üñ®Ô∏è Imprimir</button>
    <button onclick="exportarPDF()">üìÑ PDF</button>
</div>

<div id="viewMensal">
    <div class="mes-navegacao">
        <button onclick="navegarMes(-1)">‚óÄ Anterior</button>
        <h3 id="mesAtual"></h3>
        <button onclick="navegarMes(1)">Pr√≥ximo ‚ñ∂</button>
    </div>
    <div id="calendario" class="calendario-mini"></div>
</div>

<div id="viewSemanal" class="oculto"></div>

<div class="legenda">
    <div class="legenda-item"><span class="legenda-cor" style="background:#10b981;"></span>Normal</div>
    <div class="legenda-item"><span class="legenda-cor" style="background:#3b82f6;"></span>Extra</div>
    <div class="legenda-item"><span class="legenda-cor" style="background:#f59e0b;"></span>Falta/Atestado</div>
    <div class="legenda-item"><span class="legenda-cor" style="background:#8b5cf6;"></span>F√©rias</div>
    <div class="legenda-item"><span class="legenda-cor" style="background:#f1f5f9;border:1px solid #ccc;"></span>Folga</div>
</div>

<div class="qr-code-container" style="display:none;" id="qrContainer">
    <p style="font-weight:600;margin-bottom:15px;">üì± Acesse pelo celular:</p>
    <div id="qrcode"></div>
    <p id="qrLink" style="font-size:11px;margin-top:15px;opacity:0.7;"></p>
</div>
</div>

<div class="card no-print">
<h2>‚ûï Escala Avulsa</h2>
<form id="formEscala">
<input type="text" id="nome" placeholder="Nome" required>
<input type="text" id="funcao" placeholder="Fun√ß√£o" required>
<input type="date" id="data" required>
<select id="turno">
    <option value="Diurno">Diurno</option>
    <option value="Noturno">Noturno</option>
    <option value="Manh√£">Manh√£</option>
    <option value="Tarde">Tarde</option>
    <option value="Noite">Noite</option>
    <option value="24h">24h</option>
</select>
<select id="tipoServicoAvulso" required>
    <option value="normal">üü¢ Normal</option>
    <option value="extra">üîµ Extra</option>
    <option value="falta">üü† Falta/Atestado</option>
    <option value="ferias">üü£ F√©rias</option>
</select>
<textarea id="motivoAvulso" placeholder="Observa√ß√£o (opcional)" style="grid-column:1/-1;resize:vertical;min-height:80px;"></textarea>
<button type="submit" style="grid-column:1/-1;">‚ú® Adicionar</button>
</form>

<h3 style="margin-top:35px;margin-bottom:20px;font-size:1.3rem;">üìã Escalas Avulsas</h3>
<div style="overflow-x:auto;">
<table>
<thead><tr><th>Nome</th><th>Fun√ß√£o</th><th>Data</th><th>Turno</th><th>Tipo</th><th>A√ß√µes</th></tr></thead>
<tbody id="listaEscala"></tbody>
</table>
</div>
</div>

<footer class="no-print">Sistema de Escala v4.0 ‚Ä¢ Google Sheets ‚Ä¢ Sincroniza√ß√£o em Tempo Real</footer>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbx_5LMRmeL7K0SwVirzwUa7Wt_bcoCcrBpaaXrNOp9E9G5ftp49o549PSSXluOB7S1FnQ/exec";
const GOOGLE_SHEETS_URL = "COLE_O_LINK_DA_SUA_PLANILHA_AQUI";
let usarGoogleSheets = (API_URL !== "COLE_SUA_URL_AQUI");
let isSyncing = false, syncInterval = null;
let escalas = [], escalasPlantonistas = [];
let mesAtualVizualizado = new Date(), visualizacaoAtual = 'mensal';
let filtrosAtivos = {nome: '', funcao: '', tipoServico: '', periodoInicio: '', periodoFim: ''};

// Fun√ß√£o para determinar prioridade de tipo de servi√ßo
function obterPrioridadeTipo(tipo) {
    const prioridades = {
        'ferias': 4,      // Maior prioridade
        'falta': 3,
        'extra': 2,
        'normal': 1
    };
    return prioridades[tipo] || 0;
}

async function carregarDadosDoSheets() {
    if (!usarGoogleSheets) { carregarDadosLocal(); return; }
    if (isSyncing) return;
    isSyncing = true;
    updateSyncStatus('Sincronizando...', 'syncing');
    try {
        const response = await fetch(`${API_URL}?action=sync&_=${Date.now()}`);
        const data = await response.json();
        if (data.success) {
            escalasPlantonistas = data.escalasPlantonistas || [];
            escalas = data.escalasAvulsas || [];
            
            // üîß CORRE√á√ÉO: Regenerar datas para TODAS as escalas (incluindo n√£o-recorrentes)
            escalasPlantonistas.forEach(e => {
                // Se j√° tem datas salvas, usar elas
                if (e.datas && e.datas.length > 0) {
                    console.log(`‚úÖ Escala ${e.nome} j√° tem ${e.datas.length} datas`);
                    return;
                }
                
                // Se √© escala recorrente, gerar datas
                if (e.tipoOriginal && e.tipoOriginal !== 'nao-recorrente') {
                    console.log(`üîÑ Gerando datas para escala recorrente: ${e.nome}`);
                    e.datas = gerarDatasEscala(e.dataInicio, e.mesAte, e.tipoOriginal, e.horasTrabalho, e.horasFolga, e.opcoes || {});
                }
                
                // üéØ NOVO: Se √© Extra/Falta/F√©rias (n√£o-recorrente), gerar datas tamb√©m
                if (e.tipoOriginal === 'nao-recorrente' && (e.tipoServico === 'extra' || e.tipoServico === 'falta' || e.tipoServico === 'ferias')) {
                    console.log(`üéØ Gerando datas para ${e.tipoServico}: ${e.nome}, ${e.qtdDias} dias`);
                    
                    const datas = [];
                    const dataBase = new Date(e.dataInicio + "T00:00:00");
                    const qtdDias = e.qtdDias || 1;
                    
                    for(let i = 0; i < qtdDias; i++){
                        const data = new Date(dataBase);
                        data.setDate(data.getDate() + i);
                        datas.push({data: data.toISOString().split("T")[0], turno: e.turno});
                    }
                    
                    e.datas = datas;
                    console.log(`‚úÖ ${datas.length} datas geradas para ${e.nome}`);
                }
            });
            
            renderizarTudo();
            updateSyncStatus('Sincronizado ‚òÅÔ∏è', 'success');
        }
    } catch (error) {
        console.error('Erro:', error);
        updateSyncStatus('Offline', 'error');
        carregarDadosLocal();
    } finally { isSyncing = false; }
}

async function salvarNoSheets(dados, tipo) {
    if (!usarGoogleSheets) { salvarDadosLocal(); return { success: true }; }
    updateSyncStatus('Salvando...', 'syncing');
    try {
        const formData = new FormData();
        formData.append('action', tipo);
        formData.append('data', JSON.stringify(dados));
        const response = await fetch(API_URL, { method: 'POST', body: formData });
        const result = await response.json();
        if (result.success) {
            updateSyncStatus('Salvo!', 'success');
            setTimeout(() => carregarDadosDoSheets(), 1000);
        }
        return result;
    } catch (error) {
        console.error('Erro:', error);
        salvarDadosLocal();
        return { success: false };
    }
}

async function excluirDoSheets(id, tipo, index) {
    if (!usarGoogleSheets) { salvarDadosLocal(); renderizarTudo(); return; }
    let url = `${API_URL}?action=${tipo}`;
    if (id) url += `&id=${id}`;
    if (index !== undefined) url += `&index=${index}`;
    await fetch(url);
    setTimeout(() => carregarDadosDoSheets(), 1000);
}

function updateSyncStatus(msg, status) {
    const ind = document.getElementById('syncIndicator');
    const txt = document.getElementById('syncStatus');
    const api = document.getElementById('apiStatus');
    const sheetsLink = document.getElementById('sheetsLinkHeader');
    if (ind) ind.className = 'sync-indicator ' + status;
    if (txt) txt.textContent = msg;
    if (api) {
        api.innerHTML = usarGoogleSheets ? '‚úÖ <strong>Google Sheets Conectado</strong> - Dados sincronizados' : '‚ö†Ô∏è <strong>Modo Offline</strong> - Dados no navegador';
        api.style.color = usarGoogleSheets ? '#10b981' : '#f59e0b';
    }
    if (sheetsLink && GOOGLE_SHEETS_URL !== "COLE_O_LINK_DA_SUA_PLANILHA_AQUI") {
        sheetsLink.href = GOOGLE_SHEETS_URL;
        sheetsLink.style.display = 'flex';
    }
    if (status === 'success') {
        setTimeout(() => {
            if (txt) txt.textContent = 'Sincronizado ‚òÅÔ∏è';
            if (ind) ind.className = 'sync-indicator';
        }, 2000);
    }
}

function renderizarTudo() {
    renderEscalasPlantonistas();
    renderEscala();
    atualizarVisualizacao();
    calcularEstatisticas();
    renderWidgets();
}

function renderWidgets() {
    renderWidgetMesAtual();
    renderWidgetResumo();
    renderWidgetProximos();
}

function renderWidgetMesAtual() {
    const widget = document.getElementById('widgetMesAtual');
    const hoje = new Date();
    const ano = hoje.getFullYear();
    const mes = hoje.getMonth();
    const primeiroDia = new Date(ano, mes, 1).getDay();
    const ultimoDia = new Date(ano, mes + 1, 0).getDate();
    let html = '<div class="mini-calendario">';
    ['D', 'S', 'T', 'Q', 'Q', 'S', 'S'].forEach(dia => {
        html += `<div class="mini-dia mini-header">${dia}</div>`;
    });
    for (let i = 0; i < primeiroDia; i++) {
        html += '<div class="mini-dia"></div>';
    }
    for (let dia = 1; dia <= ultimoDia; dia++) {
        const dataAtual = `${ano}-${String(mes + 1).padStart(2, '0')}-${String(dia).padStart(2, '0')}`;
        const infoServico = obterInfoServico(dataAtual);
        let className = 'mini-dia ';
        if (infoServico.temServico) {
            className += `mini-servico-${infoServico.tipo}`;
        } else {
            className += 'mini-folga';
        }
        if (dia === hoje.getDate()) {
            className += ' mini-hoje';
        }
        html += `<div class="${className}" title="${infoServico.descricao}">${dia}</div>`;
    }
    html += '</div>';
    widget.innerHTML = html;
}

function renderWidgetResumo() {
    const widget = document.getElementById('resumoMes');
    const hoje = new Date();
    const ano = hoje.getFullYear();
    const mes = hoje.getMonth();
    let normais = 0, extras = 0, faltas = 0, ferias = 0, folgas = 0;
    const ultimoDia = new Date(ano, mes + 1, 0).getDate();
    for (let dia = 1; dia <= ultimoDia; dia++) {
        const dataAtual = `${ano}-${String(mes + 1).padStart(2, '0')}-${String(dia).padStart(2, '0')}`;
        const info = obterInfoServico(dataAtual);
        if (info.temServico) {
            if (info.tipo === 'normal') normais++;
            else if (info.tipo === 'extra') extras++;
            else if (info.tipo === 'falta') faltas++;
            else if (info.tipo === 'ferias') ferias++;
        } else {
            folgas++;
        }
    }
    widget.innerHTML = `üü¢ Normais: <strong>${normais}</strong><br>üîµ Extras: <strong>${extras}</strong><br>üü† Faltas: <strong>${faltas}</strong><br>üü£ F√©rias: <strong>${ferias}</strong><br>‚ö™ Folgas: <strong>${folgas}</strong>`;
}

function renderWidgetProximos() {
    const widget = document.getElementById('widgetProximos');
    const hoje = new Date();
    hoje.setHours(0, 0, 0, 0);
    let proximosServicos = [];
    for (let i = 0; i < 30; i++) {
        const data = new Date(hoje);
        data.setDate(data.getDate() + i);
        const dataStr = data.toISOString().split('T')[0];
        const info = obterInfoServico(dataStr);
        if (info.temServico) {
            proximosServicos.push({data: dataStr, info: info});
        }
        if (proximosServicos.length >= 5) break;
    }
    if (proximosServicos.length === 0) {
        widget.innerHTML = '<em style="opacity:0.6;">Nenhum servi√ßo pr√≥ximo</em>';
        return;
    }
    let html = '';
    proximosServicos.forEach(s => {
        const [ano, mes, dia] = s.data.split('-');
        const tipoIcon = s.info.tipo === 'normal' ? 'üü¢' : s.info.tipo === 'extra' ? 'üîµ' : s.info.tipo === 'falta' ? 'üü†' : 'üü£';
        html += `${tipoIcon} ${dia}/${mes}/${ano}<br>`;
    });
    widget.innerHTML = html;
}

function aplicarFiltros() {
    filtrosAtivos = {
        nome: document.getElementById('filtroNome').value.toLowerCase().trim(),
        funcao: document.getElementById('filtroFuncao').value.toLowerCase().trim(),
        tipoServico: document.getElementById('filtroTipoServico').value,
        periodoInicio: document.getElementById('filtroPeriodoInicio').value,
        periodoFim: document.getElementById('filtroPeriodoFim').value
    };
    renderEscalasPlantonistas();
    renderEscala();
    let totalPlantonistas = escalasPlantonistas.filter(filtrarEscala).length;
    let totalAvulsas = escalas.filter(filtrarEscalaAvulsa).length;
    let total = totalPlantonistas + totalAvulsas;
    document.getElementById('resultadoFiltro').textContent = `${total} registro(s) encontrado(s)`;
}

function limparFiltros() {
    document.getElementById('filtroNome').value = '';
    document.getElementById('filtroFuncao').value = '';
    document.getElementById('filtroTipoServico').value = '';
    document.getElementById('filtroPeriodoInicio').value = '';
    document.getElementById('filtroPeriodoFim').value = '';
    document.getElementById('resultadoFiltro').textContent = '';
    filtrosAtivos = {nome: '', funcao: '', tipoServico: '', periodoInicio: '', periodoFim: ''};
    renderEscalasPlantonistas();
    renderEscala();
}

function filtrarEscala(escala) {
    if (filtrosAtivos.nome && !escala.nome.toLowerCase().includes(filtrosAtivos.nome)) return false;
    if (filtrosAtivos.funcao && !escala.funcao.toLowerCase().includes(filtrosAtivos.funcao)) return false;
    if (filtrosAtivos.tipoServico && escala.tipoServico !== filtrosAtivos.tipoServico) return false;
    if (filtrosAtivos.periodoInicio || filtrosAtivos.periodoFim) {
        const inicio = filtrosAtivos.periodoInicio || '1900-01-01';
        const fim = filtrosAtivos.periodoFim || '2100-12-31';
        if (escala.dataInicio < inicio || escala.dataInicio > fim) return false;
    }
    return true;
}

function filtrarEscalaAvulsa(escala) {
    if (filtrosAtivos.nome && !escala.nome.toLowerCase().includes(filtrosAtivos.nome)) return false;
    if (filtrosAtivos.funcao && !escala.funcao.toLowerCase().includes(filtrosAtivos.funcao)) return false;
    if (filtrosAtivos.tipoServico && escala.tipoServico !== filtrosAtivos.tipoServico) return false;
    if (filtrosAtivos.periodoInicio || filtrosAtivos.periodoFim) {
        const inicio = filtrosAtivos.periodoInicio || '1900-01-01';
        const fim = filtrosAtivos.periodoFim || '2100-12-31';
        if (escala.data < inicio || escala.data > fim) return false;
    }
    return true;
}

function exportarFiltrados() {
    const plantonistas = escalasPlantonistas.filter(filtrarEscala);
    const avulsas = escalas.filter(filtrarEscalaAvulsa);
    if (plantonistas.length === 0 && avulsas.length === 0) {
        alert('Nenhum registro encontrado com os filtros aplicados.');
        return;
    }
    let csv = 'Tipo,Nome,Fun√ß√£o,Data,Turno,Tipo Servi√ßo,Observa√ß√£o\n';
    plantonistas.forEach(e => {
        if (e.datas && Array.isArray(e.datas)) {
            e.datas.forEach(d => {
                const data = typeof d === 'object' ? d.data : d;
                const turno = typeof d === 'object' ? d.turno : e.turno;
                csv += `Recorrente,"${e.nome}","${e.funcao}","${data}","${turno}","${e.tipoServico}","${e.motivo || ''}"\n`;
            });
        }
    });
    avulsas.forEach(e => {
        csv += `Avulsa,"${e.nome}","${e.funcao}","${e.data}","${e.turno}","${e.tipoServico}","${e.motivo || ''}"\n`;
    });
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `escala-filtrada-${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
}

function imprimirMes() {
    const ano = mesAtualVizualizado.getFullYear();
    const mes = mesAtualVizualizado.getMonth();
    const nomeMes = mesAtualVizualizado.toLocaleDateString('pt-BR', {month: 'long', year: 'numeric'});
    document.getElementById('printPeriodo').textContent = nomeMes.toUpperCase();
    document.getElementById('printData').textContent = new Date().toLocaleDateString('pt-BR');
    const qrContainer = document.getElementById('qrContainer');
    const qrDiv = document.getElementById('qrcode');
    qrDiv.innerHTML = '';
    qrContainer.style.display = 'block';
    const urlAtual = window.location.href.split('?')[0];
    document.getElementById('qrLink').textContent = urlAtual;
    if (typeof QRCode !== 'undefined') {
        new QRCode(qrDiv, {text: urlAtual, width: 128, height: 128});
    }
    setTimeout(() => {
        window.print();
        qrContainer.style.display = 'none';
    }, 500);
}

function carregarDadosLocal(){
    escalas = JSON.parse(localStorage.getItem("escalas")) || [];
    escalasPlantonistas = JSON.parse(localStorage.getItem("escalasPlantonistas")) || [];
    
    // üîß CORRE√á√ÉO: Regenerar datas para TODAS as escalas (incluindo n√£o-recorrentes)
    escalasPlantonistas.forEach(e => {
        // Se j√° tem datas salvas, usar elas
        if (e.datas && e.datas.length > 0) {
            console.log(`‚úÖ Escala ${e.nome} j√° tem ${e.datas.length} datas`);
            return;
        }
        
        // Se √© escala recorrente, gerar datas
        if (e.tipoOriginal && e.tipoOriginal !== 'nao-recorrente') {
            console.log(`üîÑ Gerando datas para escala recorrente: ${e.nome}`);
            e.datas = gerarDatasEscala(e.dataInicio, e.mesAte, e.tipoOriginal, e.horasTrabalho, e.horasFolga, e.opcoes || {});
        }
        
        // üéØ NOVO: Se √© Extra/Falta/F√©rias (n√£o-recorrente), gerar datas tamb√©m
        if (e.tipoOriginal === 'nao-recorrente' && (e.tipoServico === 'extra' || e.tipoServico === 'falta' || e.tipoServico === 'ferias')) {
            console.log(`üéØ Gerando datas para ${e.tipoServico}: ${e.nome}, ${e.qtdDias} dias`);
            
            const datas = [];
            const dataBase = new Date(e.dataInicio + "T00:00:00");
            const qtdDias = e.qtdDias || 1;
            
            for(let i = 0; i < qtdDias; i++){
                const data = new Date(dataBase);
                data.setDate(data.getDate() + i);
                datas.push({data: data.toISOString().split("T")[0], turno: e.turno});
            }
            
            e.datas = datas;
            console.log(`‚úÖ ${datas.length} datas geradas para ${e.nome}`);
        }
    });
    
    renderizarTudo();
}

function salvarDadosLocal(){
    if(usarGoogleSheets) return;
    localStorage.setItem("escalas", JSON.stringify(escalas));
    localStorage.setItem("escalasPlantonistas", JSON.stringify(escalasPlantonistas));
}

function toggleTheme(){
    document.body.classList.toggle('dark-mode');
    localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
}

if(localStorage.getItem('darkMode') === 'true'){
    document.body.classList.add('dark-mode');
}

function ajustarCamposTipoServico(){
    const tipoServico = document.getElementById("tipoServico").value;
    const camposExtraFalta = document.getElementById("camposExtraFalta");
    const camposRecorrentes = document.getElementById("camposRecorrentes");
    if(tipoServico === 'extra' || tipoServico === 'falta' || tipoServico === 'ferias'){
        camposExtraFalta.classList.remove("oculto");
        camposRecorrentes.style.display = "none";
        document.getElementById("tipoEscala").removeAttribute("required");
        document.getElementById("dataInicioPlantonista").removeAttribute("required");
        document.getElementById("mesFimPlantonista").removeAttribute("required");
        document.getElementById("dataUnicaServico").setAttribute("required", "required");
        document.getElementById("qtdDiasServico").setAttribute("required", "required");
    } else {
        camposExtraFalta.classList.add("oculto");
        camposRecorrentes.style.display = "contents";
        document.getElementById("tipoEscala").setAttribute("required", "required");
        document.getElementById("dataInicioPlantonista").setAttribute("required", "required");
        document.getElementById("mesFimPlantonista").setAttribute("required", "required");
        document.getElementById("dataUnicaServico").removeAttribute("required");
        document.getElementById("qtdDiasServico").removeAttribute("required");
    }
}

function ajustarCamposEscala(){
    const tipo = document.getElementById("tipoEscala").value;
    const camposPersonalizada = document.getElementById("camposPersonalizada");
    const camposDiaPosterior = document.getElementById("camposDiaPosterior");
    camposPersonalizada.classList.add("oculto");
    camposDiaPosterior.classList.add("oculto");
    if(tipo === "personalizada"){
        camposPersonalizada.classList.remove("oculto");
    }
    if(tipo === "12x24-12x72" || tipo === "12x24-12x48" || tipo === "12x24-12x96"){
        camposDiaPosterior.classList.remove("oculto");
    }
}

function gerarDatasEscala(dataInicio, mesAte, tipo, horasTrabalho, horasFolga, opcoes = {}){
    const datas = [];
    if (!tipo || tipo === 'nao-recorrente') return [];
    const inicio = new Date(dataInicio + "T00:00:00");
    const [anoFim, mesFim] = mesAte.split("-");
    const dataLimite = new Date(parseInt(anoFim), parseInt(mesFim), 0);
    let dataAtual = new Date(inicio);
    let iteracoes = 0;
    const MAX_ITERACOES = 10000;
    if(tipo === "12x24-12x72" || tipo === "12x24-12x48" || tipo === "12x24-12x96"){
        const horasFolgaFinal = tipo === "12x24-12x72" ? 72 : tipo === "12x24-12x48" ? 48 : 96;
        const marcarDiaPosterior = opcoes.marcarDiaPosterior || false;
        const diasTrabalho = marcarDiaPosterior ? 2 : 1;
        while(dataAtual <= dataLimite && iteracoes < MAX_ITERACOES){
            iteracoes++;
            for(let d = 0; d < diasTrabalho; d++){
                if(dataAtual <= dataLimite){
                    const dataStr = new Date(dataAtual).toISOString().split("T")[0];
                    datas.push({data: dataStr, turno: "Diurno"});
                    datas.push({data: dataStr, turno: "Noturno"});
                    dataAtual.setDate(dataAtual.getDate() + 1);
                }
            }
            const diasFolga = horasFolgaFinal / 24;
            dataAtual.setDate(dataAtual.getDate() + diasFolga);
        }
    }
    else if(tipo === "diario-8h"){
        while(dataAtual <= dataLimite && iteracoes < MAX_ITERACOES){
            iteracoes++;
            const diaSemana = dataAtual.getDay();
            if(diaSemana !== 0 && diaSemana !== 6){
                datas.push({data: new Date(dataAtual).toISOString().split("T")[0], turno: "08:00-16:00"});
            }
            dataAtual.setDate(dataAtual.getDate() + 1);
        }
    }
    else {
        let emServico = true;
        const incluirFinaisSemana = opcoes.incluirFinaisSemana !== undefined ? opcoes.incluirFinaisSemana : true;
        while(dataAtual <= dataLimite && iteracoes < MAX_ITERACOES){
            iteracoes++;
            const diaSemana = dataAtual.getDay();
            const ehFinalSemana = diaSemana === 0 || diaSemana === 6;
            if(emServico && (incluirFinaisSemana || !ehFinalSemana)){
                datas.push({data: new Date(dataAtual).toISOString().split("T")[0], turno: horasTrabalho === 24 ? "24h" : "Plant√£o"});
            }
            const horasAdicionar = emServico ? horasTrabalho : horasFolga;
            dataAtual.setHours(dataAtual.getHours() + horasAdicionar);
            emServico = !emServico;
        }
    }
    if(iteracoes >= MAX_ITERACOES){
        console.error("AVISO: Loop infinito detectado em gerarDatasEscala. Interrompido.");
    }
    return datas;
}

function calcularHorasEscala(tipo){
    switch(tipo){
        case "12x24-12x72": return {trabalho: 12, folga: 72};
        case "12x24-12x48": return {trabalho: 12, folga: 48};
        case "12x24-12x96": return {trabalho: 12, folga: 96};
        case "diario-8h": return {trabalho: 8, folga: 0};
        case "24x48": return {trabalho: 24, folga: 48};
        case "24x72": return {trabalho: 24, folga: 72};
        default: return null;
    }
}

document.getElementById("formEscalaPlantonista").addEventListener("submit", async (e) => {
    e.preventDefault();
    const tipoServico = document.getElementById("tipoServico").value;
    const nome = document.getElementById("nomePlantonista").value;
    const funcao = document.getElementById("funcaoPlantonista").value;
    const turno = document.getElementById("turnoPlantonista").value;
    const motivo = document.getElementById("motivoServico").value;
    
    if(tipoServico === 'extra' || tipoServico === 'falta' || tipoServico === 'ferias'){
        const dataInicio = document.getElementById("dataUnicaServico").value;
        const qtdDias = parseInt(document.getElementById("qtdDiasServico").value);
        const datas = [];
        const dataBase = new Date(dataInicio + "T00:00:00");
        for(let i = 0; i < qtdDias; i++){
            const data = new Date(dataBase);
            data.setDate(data.getDate() + i);
            datas.push({data: data.toISOString().split("T")[0], turno: turno});
        }
        const escala = {
            id: Date.now(), nome, funcao, tipoServico,
            tipoEscala: `${qtdDias} dia(s)`,
            tipoOriginal: 'nao-recorrente',
            dataInicio, mesAte: dataInicio.substring(0, 7),
            turno, motivo, qtdDias, datas
        };
        escalasPlantonistas.push(escala);
        await salvarNoSheets(escala, 'saveEscalaPlantonista');
        e.target.reset();
        ajustarCamposTipoServico();
        return;
    }
    
    const tipo = document.getElementById("tipoEscala").value;
    let horasTrabalho, horasFolga;
    let tipoEscalaDisplay = tipo;
    const opcoes = {};
    
    if(tipo === "12x24-12x72" || tipo === "12x24-12x48" || tipo === "12x24-12x96"){
        opcoes.marcarDiaPosterior = document.getElementById("marcarDiaPosterior").checked;
    }
    
    if(tipo === "personalizada"){
        horasTrabalho = parseInt(document.getElementById("horasTrabalho").value);
        horasFolga = parseInt(document.getElementById("horasFolga").value);
        tipoEscalaDisplay = `${horasTrabalho}x${horasFolga}`;
        opcoes.incluirFinaisSemana = document.getElementById("incluirFinaisSemana").checked;
    } else {
        const horas = calcularHorasEscala(tipo);
        horasTrabalho = horas.trabalho;
        horasFolga = horas.folga;
    }
    
    const escala = {
        id: Date.now(), nome, funcao, tipoServico,
        tipoEscala: tipoEscalaDisplay,
        tipoOriginal: tipo,
        dataInicio: document.getElementById("dataInicioPlantonista").value,
        mesAte: document.getElementById("mesFimPlantonista").value,
        turno, motivo, horasTrabalho, horasFolga, opcoes,
        datas: gerarDatasEscala(
            document.getElementById("dataInicioPlantonista").value,
            document.getElementById("mesFimPlantonista").value,
            tipo, horasTrabalho, horasFolga, opcoes
        )
    };
    escalasPlantonistas.push(escala);
    await salvarNoSheets(escala, 'saveEscalaPlantonista');
    e.target.reset();
    ajustarCamposEscala();
    ajustarCamposTipoServico();
});

function renderEscalasPlantonistas(){
    const lista = document.getElementById("listaEscalasPlantonistas");
    lista.innerHTML = "";
    const escalasFiltradas = escalasPlantonistas.filter(filtrarEscala);
    escalasFiltradas.forEach((e)=>{
        const [ano, mes] = e.mesAte.split("-");
        const mesFormatado = `${mes}/${ano}`;
        let tipoDisplay = e.tipoEscala;
        const tipoServicoIcon = e.tipoServico === 'normal' ? 'üü¢' : e.tipoServico === 'extra' ? 'üîµ' : e.tipoServico === 'falta' ? 'üü†' : 'üü£';
        if(e.tipoOriginal === "12x24-12x72") tipoDisplay = "12x24+12x72";
        if(e.tipoOriginal === "12x24-12x48") tipoDisplay = "12x24+12x48";
        if(e.tipoOriginal === "12x24-12x96") tipoDisplay = "12x24+12x96";
        if(e.tipoOriginal === "diario-8h") tipoDisplay = "Di√°rio 8h";
        if(e.opcoes && e.opcoes.marcarDiaPosterior) tipoDisplay += " (2d)";
        if(e.opcoes && e.opcoes.incluirFinaisSemana) tipoDisplay += " (c/FDS)";
        if(e.opcoes && e.opcoes.incluirFinaisSemana === false) tipoDisplay += " (s/FDS)";
        lista.innerHTML += `<tr><td>${e.nome}</td><td>${e.funcao}</td><td>${tipoServicoIcon}</td><td>${tipoDisplay}</td><td>${e.dataInicio.split("-").reverse().join("/")}</td><td>${mesFormatado}</td><td><button class="btn-edit" onclick="editarEscalaPlantonista(${e.id})">Editar</button><button class="btn-del" onclick="delEscalaPlantonista(${e.id})">Excluir</button></td></tr>`;
    });
}

function editarEscalaPlantonista(id){
    const escala = escalasPlantonistas.find(e => e.id === id);
    if(!escala) return;
    document.getElementById("formEscalaPlantonista").reset();
    document.getElementById("formEscalaPlantonista").scrollIntoView({ behavior: 'smooth', block: 'start' });
    document.getElementById("nomePlantonista").value = escala.nome;
    document.getElementById("funcaoPlantonista").value = escala.funcao;
    document.getElementById("tipoServico").value = escala.tipoServico;
    document.getElementById("turnoPlantonista").value = escala.turno;
    document.getElementById("motivoServico").value = escala.motivo || "";
    ajustarCamposTipoServico();
    
    setTimeout(() => {
        if(escala.tipoServico === 'extra' || escala.tipoServico === 'falta' || escala.tipoServico === 'ferias'){
            document.getElementById("dataUnicaServico").value = escala.dataInicio;
            document.getElementById("qtdDiasServico").value = escala.qtdDias || 1;
        } else {
            document.getElementById("dataInicioPlantonista").value = escala.dataInicio;
            document.getElementById("mesFimPlantonista").value = escala.mesAte;
            const tipo = escala.tipoOriginal || escala.tipoEscala;
            if(tipo && tipo !== "nao-recorrente"){
                if(tipo === "personalizada" || (!["12x24-12x72","12x24-12x48","12x24-12x96","diario-8h","24x48","24x72"].includes(tipo))){
                    document.getElementById("tipoEscala").value = "personalizada";
                    ajustarCamposEscala();
                    setTimeout(() => {
                        if(escala.horasTrabalho){
                            document.getElementById("horasTrabalho").value = escala.horasTrabalho;
                            document.getElementById("horasFolga").value = escala.horasFolga;
                        }
                        if(escala.opcoes && escala.opcoes.incluirFinaisSemana !== undefined){
                            document.getElementById("incluirFinaisSemana").checked = escala.opcoes.incluirFinaisSemana;
                        }
                    }, 50);
                } else {
                    document.getElementById("tipoEscala").value = tipo;
                    ajustarCamposEscala();
                    setTimeout(() => {
                        if(tipo === "12x24-12x72" || tipo === "12x24-12x48" || tipo === "12x24-12x96"){
                            if(escala.opcoes && escala.opcoes.marcarDiaPosterior !== undefined){
                                document.getElementById("marcarDiaPosterior").checked = escala.opcoes.marcarDiaPosterior;
                            }
                        }
                    }, 50);
                }
            }
        }
    }, 100);
    
    escalasPlantonistas = escalasPlantonistas.filter(e => e.id !== id);
    salvarDadosLocal();
    renderEscalasPlantonistas();
    atualizarVisualizacao();
    calcularEstatisticas();
}

async function delEscalaPlantonista(id){
    if(!confirm("Deseja excluir esta escala?")) return;
    escalasPlantonistas = escalasPlantonistas.filter(e => e.id !== id);
    await excluirDoSheets(id, 'deleteEscalaPlantonista');
}

function obterInfoServico(data){
    let servicos = [];
    
    // Coletar todos os servi√ßos da data
    for(let escala of escalasPlantonistas){
        if(escala.datas && Array.isArray(escala.datas)){
            for(let dia of escala.datas){
                const diaData = typeof dia === 'object' ? dia.data : dia;
                const diaTurno = typeof dia === 'object' ? dia.turno : escala.turno;
                if(diaData === data){
                    servicos.push({
                        nome: escala.nome, 
                        turno: diaTurno, 
                        tipo: escala.tipoServico, 
                        motivo: escala.motivo,
                        prioridade: obterPrioridadeTipo(escala.tipoServico)
                    });
                }
            }
        }
    }
    
    for(let escala of escalas){
        if(escala.data === data){
            servicos.push({
                nome: escala.nome, 
                turno: escala.turno, 
                tipo: escala.tipoServico, 
                motivo: escala.motivo,
                prioridade: obterPrioridadeTipo(escala.tipoServico)
            });
        }
    }
    
    if(servicos.length > 0){
        // Ordenar por prioridade (maior primeiro)
        servicos.sort((a, b) => b.prioridade - a.prioridade);
        
        // Usar o tipo de maior prioridade para a cor
        const tipoExibicao = servicos[0].tipo;
        
        let descricao = "Servi√ßo:\n";
        servicos.forEach(s => {
            const tipoLabel = s.tipo === 'normal' ? '' : s.tipo === 'extra' ? ' (EXTRA)' : s.tipo === 'falta' ? ' (FALTA)' : ' (F√âRIAS)';
            descricao += `${s.nome} - ${s.turno}${tipoLabel}`;
            if(s.motivo) descricao += ` - ${s.motivo}`;
            descricao += "\n";
        });
        
        return { temServico: true, tipo: tipoExibicao, descricao: descricao.trim() };
    }
    return { temServico: false, tipo: null, descricao: "Folga" };
}

function renderCalendario(){
    const ano = mesAtualVizualizado.getFullYear();
    const mes = mesAtualVizualizado.getMonth();
    document.getElementById("mesAtual").textContent = mesAtualVizualizado.toLocaleDateString("pt-BR", {month: "long", year: "numeric"});
    const primeiroDia = new Date(ano, mes, 1).getDay();
    const ultimoDia = new Date(ano, mes + 1, 0).getDate();
    const calendario = document.getElementById("calendario");
    calendario.innerHTML = "";
    
    ["Dom", "Seg", "Ter", "Qua", "Qui", "Sex", "S√°b"].forEach(dia => {
        const div = document.createElement("div");
        div.className = "dia-calendario dia-header";
        div.textContent = dia;
        calendario.appendChild(div);
    });
    
    for(let i = 0; i < primeiroDia; i++){
        const div = document.createElement("div");
        div.className = "dia-calendario";
        calendario.appendChild(div);
    }
    
    const hoje = new Date();
    hoje.setHours(0,0,0,0);
    
    for(let dia = 1; dia <= ultimoDia; dia++){
        const dataAtual = `${ano}-${String(mes + 1).padStart(2, "0")}-${String(dia).padStart(2, "0")}`;
        const infoServico = obterInfoServico(dataAtual);
        const dataCalendario = new Date(ano, mes, dia);
        const ehPassado = dataCalendario < hoje;
        
        const div = document.createElement("div");
        let className = "dia-calendario ";
        if(infoServico.temServico){
            className += `dia-servico-${infoServico.tipo}`;
        } else {
            className += "dia-folga";
        }
        if(ehPassado) className += " dia-passado";
        div.className = className;
        div.textContent = dia;
        div.title = infoServico.descricao;
        calendario.appendChild(div);
    }
}

function navegarMes(direcao){
    mesAtualVizualizado.setMonth(mesAtualVizualizado.getMonth() + direcao);
    renderCalendario();
    renderWidgets();
}

function renderSemanal(){
    const inicio = new Date(mesAtualVizualizado);
    inicio.setDate(inicio.getDate() - inicio.getDay());
    const viewSemanal = document.getElementById("viewSemanal");
    viewSemanal.innerHTML = `<div class="mes-navegacao"><button onclick="navegarSemana(-1)">‚óÄ Anterior</button><h3>Semana de ${inicio.toLocaleDateString("pt-BR")}</h3><button onclick="navegarSemana(1)">Pr√≥xima ‚ñ∂</button></div><div class="semana-grid" id="semanaGrid"></div>`;
    const grid = document.getElementById("semanaGrid");
    const diasSemana = ["Domingo", "Segunda", "Ter√ßa", "Quarta", "Quinta", "Sexta", "S√°bado"];
    
    for(let i = 0; i < 7; i++){
        const data = new Date(inicio);
        data.setDate(data.getDate() + i);
        const dataStr = data.toISOString().split("T")[0];
        const infoServico = obterInfoServico(dataStr);
        
        const card = document.createElement("div");
        card.className = "dia-semana-card";
        let html = `<h5>${diasSemana[i]}<br>${data.getDate()}/${data.getMonth()+1}</h5>`;
        if(infoServico.temServico){
            const servicos = infoServico.descricao.split("\n").slice(1);
            servicos.forEach(s => {
                if(s.trim()){
                    html += `<div class="servico-item servico-${infoServico.tipo}">${s}</div>`;
                }
            });
        } else {
            html += `<div style="text-align:center;padding:20px;opacity:0.5;">Folga</div>`;
        }
        card.innerHTML = html;
        grid.appendChild(card);
    }
}

function navegarSemana(direcao){
    mesAtualVizualizado.setDate(mesAtualVizualizado.getDate() + (direcao * 7));
    renderSemanal();
}

function buscarPeriodo(){
    const dataInicio = document.getElementById("dataInicioBusca").value;
    const dataFim = document.getElementById("dataFimBusca").value;
    if(!dataInicio && !dataFim){
        alert("Por favor, informe pelo menos uma data para buscar.");
        return;
    }
    if(dataInicio){
        const [ano, mes] = dataInicio.split("-");
        mesAtualVizualizado = new Date(parseInt(ano), parseInt(mes) - 1, 1);
        atualizarVisualizacao();
    }
}

function voltarHoje(){
    mesAtualVizualizado = new Date();
    document.getElementById("dataInicioBusca").value = "";
    document.getElementById("dataFimBusca").value = "";
    mudarVisualizacao('mensal');
}

function mudarVisualizacao(tipo){
    visualizacaoAtual = tipo;
    document.getElementById("btnMensal").classList.remove("active");
    document.getElementById("btnSemanal").classList.remove("active");
    document.getElementById("viewMensal").classList.add("oculto");
    document.getElementById("viewSemanal").classList.add("oculto");
    if(tipo === 'mensal'){
        document.getElementById("btnMensal").classList.add("active");
        document.getElementById("viewMensal").classList.remove("oculto");
        renderCalendario();
    } else if(tipo === 'semanal'){
        document.getElementById("btnSemanal").classList.add("active");
        document.getElementById("viewSemanal").classList.remove("oculto");
        renderSemanal();
    }
}

function atualizarVisualizacao(){
    if(visualizacaoAtual === 'mensal') renderCalendario();
    else if(visualizacaoAtual === 'semanal') renderSemanal();
}

function calcularEstatisticas(){
    let normais = 0, extras = 0, faltas = 0, dispensaMedica = 0, ferias = 0, avulsoCount = 0;
    let datasNormais = new Set(), datasExtras = new Set(), datasFaltas = new Set(), datasDispensa = new Set(), datasFerias = new Set(), datasAvulso = new Set();
    
    // Coletar dados das escalas plantonistas
    escalasPlantonistas.forEach(e => {
        if(e.datas && Array.isArray(e.datas)){
            e.datas.forEach(d => {
                const data = typeof d === 'object' ? d.data : d;
                if(e.tipoServico === 'normal'){
                    datasNormais.add(data);
                } else if(e.tipoServico === 'extra'){
                    datasExtras.add(data);
                } else if(e.tipoServico === 'falta'){
                    if(e.datas.length > 8){
                        datasDispensa.add(data);
                    } else {
                        datasFaltas.add(data);
                    }
                } else if(e.tipoServico === 'ferias'){
                    datasFerias.add(data);
                }
            });
        }
    });
    
    // Coletar dados das escalas avulsas
    escalas.forEach(e => {
        avulsoCount++;
        datasAvulso.add(e.data);
        if(e.tipoServico === 'normal') datasNormais.add(e.data);
        else if(e.tipoServico === 'extra') datasExtras.add(e.data);
        else if(e.tipoServico === 'falta') datasFaltas.add(e.data);
        else if(e.tipoServico === 'ferias') datasFerias.add(e.data);
    });
    
    // Calcular totais
    normais = datasNormais.size;
    extras = datasExtras.size;
    faltas = datasFaltas.size;
    dispensaMedica = datasDispensa.size;
    ferias = datasFerias.size;
    const avulsoDias = datasAvulso.size;
    
    // üîß CORRE√á√ÉO: C√°lculo correto de dias trabalhados e folgas
    // DIAS TRABALHADOS = Normais + Extras + Avulsos - Faltas - Dispensas
    const diasTrabalhados = normais + extras + avulsoDias - faltas - dispensaMedica;
    
    // Calcular per√≠odo total
    let totalFolgas = 0;
    let todasDatas = new Set([...datasNormais, ...datasExtras, ...datasFaltas, ...datasDispensa, ...datasFerias, ...datasAvulso]);
    
    if(todasDatas.size > 0){
        const datasArray = Array.from(todasDatas).sort();
        const primeiraData = datasArray[0];
        const ultimaData = datasArray[datasArray.length - 1];
        const dataMinima = new Date(primeiraData + 'T00:00:00');
        const dataMaxima = new Date(ultimaData + 'T00:00:00');
        const diffTime = dataMaxima.getTime() - dataMinima.getTime();
        const totalDiasPeriodo = Math.floor(diffTime / (1000 * 60 * 60 * 24)) + 1;
        
        // FOLGAS = Total de dias do per√≠odo - Dias efetivamente trabalhados - F√©rias
        totalFolgas = totalDiasPeriodo - diasTrabalhados - ferias;
        if(totalFolgas < 0) totalFolgas = 0;
    }
    
    // Atualizar interface
    document.getElementById("statNormais").textContent = normais;
    document.getElementById("statExtras").textContent = extras;
    document.getElementById("statFaltas").textContent = faltas;
    document.getElementById("statDispensa").textContent = dispensaMedica;
    document.getElementById("statFerias").textContent = ferias;
    document.getElementById("statAvulso").textContent = avulsoCount;
    document.getElementById("statFolgas").textContent = totalFolgas;
    document.getElementById("statTotal").textContent = diasTrabalhados; // ‚Üê CORRIGIDO
    
    // üéØ LOGS PARA DEBUG (opcional - pode comentar depois)
    console.log('=== üìä ESTAT√çSTICAS ===');
    console.log('Normais:', normais);
    console.log('Extras:', extras);
    console.log('Avulsos:', avulsoDias);
    console.log('Faltas:', faltas);
    console.log('Dispensas:', dispensaMedica);
    console.log('F√©rias:', ferias);
    console.log('---');
    console.log('DIAS TRABALHADOS:', diasTrabalhados, '=', normais, '+', extras, '+', avulsoDias, '-', faltas, '-', dispensaMedica);
    console.log('FOLGAS:', totalFolgas);
    console.log('==================');
}


async function exportarPDF(){
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('p', 'mm', 'a4');
    const elemento = document.querySelector('.card');
    const canvas = await html2canvas(elemento, {scale: 2, backgroundColor: '#ffffff'});
    const imgData = canvas.toDataURL('image/png');
    const imgWidth = 190;
    const imgHeight = (canvas.height * imgWidth) / canvas.width;
    pdf.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeight);
    pdf.save('escala-servico.pdf');
}

function renderEscala(){
    const lista = document.getElementById("listaEscala");
    lista.innerHTML = "";
    const escalasFiltradas = escalas.filter(filtrarEscalaAvulsa);
    escalasFiltradas.forEach((e,i)=>{
        const tipoIcon = e.tipoServico === 'normal' ? 'üü¢' : e.tipoServico === 'extra' ? 'üîµ' : e.tipoServico === 'falta' ? 'üü†' : 'üü£';
        const indexOriginal = escalas.indexOf(e);
        lista.innerHTML += `<tr><td>${e.nome}</td><td>${e.funcao}</td><td>${e.data.split("-").reverse().join("/")}</td><td>${e.turno}</td><td>${tipoIcon}</td><td><button class="btn-edit" onclick="editarEscala(${indexOriginal})">Editar</button><button class="btn-del" onclick="delEscala(${indexOriginal})">Excluir</button></td></tr>`;
    });
}

function editarEscala(i){
    const e = escalas[i];
    document.getElementById("formEscala").reset();
    document.getElementById("formEscala").scrollIntoView({ behavior: 'smooth', block: 'start' });
    document.getElementById("nome").value = e.nome;
    document.getElementById("funcao").value = e.funcao;
    document.getElementById("data").value = e.data;
    document.getElementById("turno").value = e.turno;
    document.getElementById("tipoServicoAvulso").value = e.tipoServico;
    document.getElementById("motivoAvulso").value = e.motivo || "";
    escalas.splice(i, 1);
    salvarDadosLocal();
    renderEscala();
    atualizarVisualizacao();
    calcularEstatisticas();
}

document.getElementById("formEscala").addEventListener("submit", async (e) => {
    e.preventDefault();
    const escala = {
        nome: nome.value, 
        funcao: funcao.value, 
        data: data.value, 
        turno: turno.value, 
        tipoServico: tipoServicoAvulso.value, 
        motivo: motivoAvulso.value
    };
    escalas.push(escala);
    await salvarNoSheets(escala, 'saveEscalaAvulsa');
    e.target.reset();
});

async function delEscala(i){
    if(!confirm("Deseja excluir esta escala?")) return;
    escalas.splice(i,1);
    await excluirDoSheets(null, 'deleteEscalaAvulsa', i);
}

window.addEventListener('DOMContentLoaded', () => {
    if (usarGoogleSheets) {
        carregarDadosDoSheets();
        syncInterval = setInterval(() => {
            if (!isSyncing) carregarDadosDoSheets();
        }, 5000);
    } else {
        carregarDadosLocal();
    }
    updateSyncStatus('Pronto', 'success');
});

window.addEventListener('beforeunload', () => {
    if (syncInterval) clearInterval(syncInterval);
});
</script>
</body>
</html>
