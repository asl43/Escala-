<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Sistema de Escala de Servi√ßo - Google Sheets</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
:root {
    --bg-gradient-start: #1e3c72;
    --bg-gradient-end: #2a5298;
    --card-bg: #fff;
    --text-color: #333;
    --header-bg: #1e3c72;
    --header-text: #fff;
    --border-color: #ccc;
    --info-box-bg: #e8f4f8;
}

body.dark-mode {
    --bg-gradient-start: #0f1419;
    --bg-gradient-end: #1a1f2e;
    --card-bg: #1e2530;
    --text-color: #e0e0e0;
    --header-bg: #2d3748;
    --header-text: #fff;
    --border-color: #4a5568;
    --info-box-bg: #2d3748;
}

body{
    font-family: Arial, sans-serif;
    background: linear-gradient(135deg, var(--bg-gradient-start), var(--bg-gradient-end));
    margin:0;
    padding:0;
    color: var(--text-color);
    transition: all 0.3s ease;
    min-height:100vh;
}
.container{
    max-width:1400px;
    margin:auto;
    padding:20px;
}
.header-controls{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:20px;
    flex-wrap:wrap;
    gap:10px;
}
h1{
    color:#fff;
    margin:0;
}
.sync-badge{
    background: var(--card-bg);
    padding:8px 15px;
    border-radius:20px;
    font-size:12px;
    display:flex;
    align-items:center;
    gap:8px;
    font-weight:bold;
}
.sync-indicator{
    width:10px;
    height:10px;
    border-radius:50%;
    background:#27ae60;
    animation: pulse 2s infinite;
}
.sync-indicator.syncing{
    background:#3498db;
}
.sync-indicator.error{
    background:#e74c3c;
}
@keyframes pulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.6; transform: scale(1.1); }
}
.theme-toggle{
    background: var(--card-bg);
    border:none;
    padding:10px 20px;
    border-radius:5px;
    cursor:pointer;
    color: var(--text-color);
    font-weight:bold;
}
.theme-toggle:hover{
    opacity:0.8;
}
.card{
    background: var(--card-bg);
    border-radius:10px;
    padding:20px;
    margin-bottom:20px;
    box-shadow:0 4px 10px rgba(0,0,0,.2);
}
.card h2{
    margin-top:0;
    color: var(--header-bg);
}
body.dark-mode .card h2{
    color: #60a5fa;
}
form{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
    gap:10px;
    margin-bottom:15px;
}
input, select, button, textarea{
    padding:10px;
    border-radius:5px;
    border:1px solid var(--border-color);
    background: var(--card-bg);
    color: var(--text-color);
}
button{
    background: var(--header-bg);
    color: var(--header-text);
    cursor:pointer;
    border:none;
    transition: all 0.2s;
}
button:hover{
    opacity:0.9;
    transform: translateY(-1px);
}
.btn-edit{
    background:#27ae60;
    color:#fff;
    border:none;
    padding:5px 8px;
    border-radius:5px;
    cursor:pointer;
    margin-right:5px;
}
.btn-edit:hover{
    background:#1e8449;
}
.btn-del{
    background:#c0392b;
    color:#fff;
    border:none;
    padding:5px 8px;
    border-radius:5px;
    cursor:pointer;
}
.btn-del:hover{
    background:#922b21;
}
table{
    width:100%;
    border-collapse:collapse;
    margin-top:10px;
    overflow-x:auto;
}
th, td{
    padding:8px;
    border:1px solid var(--border-color);
    text-align:center;
}
th{
    background: var(--header-bg);
    color: var(--header-text);
}
.oculto{
    display:none;
}
.info-box{
    background: var(--info-box-bg);
    padding:10px;
    border-radius:5px;
    margin-bottom:10px;
    font-size:14px;
}
.calendario-mini{
    display:grid;
    grid-template-columns:repeat(7,1fr);
    gap:5px;
    margin-top:10px;
}
.dia-calendario{
    padding:10px 8px;
    border:1px solid var(--border-color);
    border-radius:5px;
    text-align:center;
    font-size:12px;
    cursor:pointer;
    transition: transform 0.2s;
    min-height:40px;
    display:flex;
    flex-direction:column;
    justify-content:center;
}
.dia-calendario:hover:not(.dia-header){
    transform: scale(1.05);
}
.dia-servico-normal{
    background:#27ae60;
    color:#fff;
    font-weight:bold;
}
.dia-servico-extra{
    background:#3498db;
    color:#fff;
    font-weight:bold;
}
.dia-servico-falta{
    background:#e67e22;
    color:#fff;
    font-weight:bold;
}
.dia-folga{
    background:#f0f0f0;
}
body.dark-mode .dia-folga{
    background:#374151;
    color:#9ca3af;
}
.dia-header{
    background: var(--header-bg);
    color: var(--header-text);
    font-weight:bold;
}
.dia-passado{
    opacity:0.6;
}
.mes-navegacao{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:10px;
    gap:10px;
    flex-wrap:wrap;
}
.mes-navegacao button{
    padding:8px 15px;
}
.view-controls{
    display:flex;
    gap:10px;
    margin-bottom:15px;
    flex-wrap:wrap;
}
.view-controls button, .view-controls select{
    padding:8px 15px;
    flex:1;
    min-width:120px;
}
.view-controls button.active{
    background:#27ae60;
}
.legenda{
    margin-top:15px;
    display:flex;
    gap:20px;
    justify-content:center;
    font-size:14px;
    flex-wrap:wrap;
}
.legenda-item{
    display:flex;
    align-items:center;
    gap:8px;
}
.legenda-cor{
    display:inline-block;
    width:20px;
    height:20px;
    border-radius:3px;
}
.stats-grid{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
    gap:15px;
    margin-top:15px;
}
.stat-card{
    background: var(--info-box-bg);
    padding:20px;
    border-radius:8px;
    text-align:center;
}
.stat-number{
    font-size:36px;
    font-weight:bold;
    color: var(--header-bg);
    margin:10px 0;
}
body.dark-mode .stat-number{
    color:#60a5fa;
}
.stat-label{
    font-size:14px;
    color: var(--text-color);
    opacity:0.8;
}
.multi-month-grid{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(300px,1fr));
    gap:20px;
    margin-top:20px;
}
.month-card{
    background: var(--info-box-bg);
    padding:15px;
    border-radius:8px;
}
.month-card h4{
    margin:0 0 10px 0;
    text-align:center;
    color: var(--header-bg);
}
body.dark-mode .month-card h4{
    color:#60a5fa;
}
.semana-view{
    margin-top:20px;
}
.semana-grid{
    display:grid;
    grid-template-columns:repeat(7,1fr);
    gap:10px;
}
.dia-semana-card{
    background: var(--info-box-bg);
    padding:15px;
    border-radius:8px;
    min-height:150px;
}
.dia-semana-card h5{
    margin:0 0 10px 0;
    color: var(--header-bg);
    border-bottom:2px solid var(--border-color);
    padding-bottom:5px;
}
body.dark-mode .dia-semana-card h5{
    color:#60a5fa;
}
.servico-item{
    padding:8px;
    margin:5px 0;
    border-radius:5px;
    font-size:12px;
}
.servico-normal{
    background:#27ae60;
    color:#fff;
}
.servico-extra{
    background:#3498db;
    color:#fff;
}
.servico-falta{
    background:#e67e22;
    color:#fff;
}
footer{
    text-align:center;
    color:#fff;
    margin-top:20px;
    font-size:14px;
}
@media print {
    .no-print { display: none !important; }
    body { background: white !important; color: black !important; }
    .card { box-shadow: none !important; page-break-inside: avoid; }
    .header-controls, .view-controls, .mes-navegacao button { display: none !important; }
}
@media (max-width: 768px){
    .calendario-mini{
        gap:2px;
    }
    .dia-calendario{
        padding:5px 2px;
        font-size:10px;
        min-height:30px;
    }
    .semana-grid{
        grid-template-columns:1fr;
    }
}
</style>
</head>

<body>
<div class="container">

<div class="header-controls no-print">
<h1>üìÖ Sistema de Escala - Google Sheets</h1>
<div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
    <div class="sync-badge">
        <div class="sync-indicator" id="syncIndicator"></div>
        <span id="syncStatus">Sincronizado ‚òÅÔ∏è</span>
    </div>
    <button class="theme-toggle" onclick="toggleTheme()">üåì Modo Escuro/Claro</button>
</div>
</div>

<div class="card no-print">
<div class="info-box" style="text-align:center;">
    <span id="apiStatus">‚òÅÔ∏è <strong>Conectado ao Google Sheets</strong> - Sincroniza√ß√£o autom√°tica</span>
</div>
</div>

<!-- ESTAT√çSTICAS -->
<div class="card">
<h2>üìä Estat√≠sticas</h2>
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-label">Servi√ßos Normais</div>
        <div class="stat-number" id="statNormais">0</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Servi√ßos Extras</div>
        <div class="stat-number" id="statExtras">0</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Faltas/Atestados</div>
        <div class="stat-number" id="statFaltas">0</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Dispensa M√©dica</div>
        <div class="stat-number" id="statDispensa">0</div>
        <small style="font-size:11px;opacity:0.7;">(Acima de 8 dias)</small>
    </div>
    <div class="stat-card">
        <div class="stat-label">Avulso/Permuta</div>
        <div class="stat-number" id="statAvulso">0</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Total de Folgas</div>
        <div class="stat-number" id="statFolgas">0</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Total de Dias Trabalhados</div>
        <div class="stat-number" id="statTotal">0</div>
    </div>
</div>
</div>

<!-- ESCALA PLANTONISTA RECORRENTE -->
<div class="card no-print">
<h2>üîÑ Escala Plantonista Recorrente</h2>
<div class="info-box">
    Configure sua escala de plant√µes que se repetem automaticamente. Escolha o tipo de servi√ßo e adicione observa√ß√µes se necess√°rio.
</div>

<form id="formEscalaPlantonista">
    <input type="text" id="nomePlantonista" placeholder="Nome" required>
    <input type="text" id="funcaoPlantonista" placeholder="Fun√ß√£o" required>
    
    <select id="tipoServico" required onchange="ajustarCamposTipoServico()">
        <option value="">Tipo de Servi√ßo</option>
        <option value="normal">üü¢ Servi√ßo Normal</option>
        <option value="extra">üîµ Servi√ßo Extra</option>
        <option value="falta">üü† Falta/Atestado</option>
    </select>
    
    <div id="camposExtraFalta" class="oculto" style="grid-column:1/-1;">
        <div style="background:var(--info-box-bg);padding:15px;border-radius:5px;margin-top:10px;">
            <p style="margin:0 0 10px 0;font-weight:bold;">‚ö†Ô∏è Servi√ßos Extra e Faltas n√£o s√£o recorrentes</p>
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px;">
                <input type="date" id="dataUnicaServico" placeholder="Data do servi√ßo">
                <input type="number" id="qtdDiasServico" placeholder="Quantidade de dias" min="1" max="365">
            </div>
            <small style="display:block;margin-top:5px;color:#555;">
                O sistema marcar√° a quantidade de dias informada a partir da data selecionada.<br>
                <strong>Mais de 8 dias ser√° contabilizado como Dispensa M√©dica.</strong>
            </small>
        </div>
    </div>
    
    <div id="camposRecorrentes" style="grid-column:1/-1;display:contents;">
    
    <select id="tipoEscala" onchange="ajustarCamposEscala()" required>
        <option value="">Tipo de Escala</option>
        <option value="12x24-12x72">12x24 + 12x72</option>
        <option value="12x24-12x48">12x24 + 12x48</option>
        <option value="12x24-12x96">12x24 + 12x96</option>
        <option value="diario-8h">Di√°rio 8h (Comercial)</option>
        <option value="24x48">24x48</option>
        <option value="24x72">24x72</option>
        <option value="personalizada">Personalizada</option>
    </select>
    
    <div id="camposDiaPosterior" class="oculto" style="grid-column:1/-1;">
        <div style="background:var(--info-box-bg);padding:10px;border-radius:5px;margin-top:10px;">
            <label style="display:flex;align-items:center;gap:10px;cursor:pointer;">
                <input type="checkbox" id="marcarDiaPosterior">
                <span>‚úÖ Marcar o dia seguinte tamb√©m (2 dias consecutivos)?</span>
            </label>
        </div>
    </div>
    
    <div id="camposPersonalizada" class="oculto" style="grid-column:1/-1;">
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px;margin-top:10px;">
            <input type="number" id="horasTrabalho" placeholder="Horas de trabalho" min="1">
            <input type="number" id="horasFolga" placeholder="Horas de folga" min="1">
        </div>
        <div style="background:var(--info-box-bg);padding:10px;border-radius:5px;margin-top:10px;">
            <label style="display:flex;align-items:center;gap:10px;cursor:pointer;">
                <input type="checkbox" id="incluirFinaisSemana">
                <span>Incluir finais de semana?</span>
            </label>
        </div>
    </div>
    
    <input type="date" id="dataInicioPlantonista" required>
    <input type="month" id="mesFimPlantonista" required>
    
    </div>
    
    <select id="turnoPlantonista">
        <option value="Diurno">Diurno</option>
        <option value="Noturno">Noturno</option>
        <option value="Manh√£">Manh√£</option>
        <option value="Tarde">Tarde</option>
        <option value="Noite">Noite</option>
        <option value="24h">24h</option>
    </select>
    
    <textarea id="motivoServico" placeholder="Motivo/Observa√ß√£o (opcional)" style="grid-column:1/-1;resize:vertical;"></textarea>
    
    <button type="submit" style="grid-column:1/-1;">Gerar Escala</button>
</form>

<h3>Escalas Cadastradas</h3>
<div style="overflow-x:auto;">
<table>
<thead>
<tr>
<th>Nome</th>
<th>Fun√ß√£o</th>
<th>Tipo Servi√ßo</th>
<th>Escala</th>
<th>In√≠cio</th>
<th>At√©</th>
<th>A√ß√µes</th>
</tr>
</thead>
<tbody id="listaEscalasPlantonistas"></tbody>
</table>
</div>
</div>

<!-- VISUALIZA√á√ÉO DO CALEND√ÅRIO -->
<div class="card">
<h2>üìÜ Calend√°rio</h2>

<div class="info-box no-print">
    <strong>üîç Busca Retroativa:</strong> Navegue pelos meses/anos anteriores ou use os filtros abaixo para verificar seu hist√≥rico de trabalho.
</div>

<div class="view-controls no-print" style="border-bottom:1px solid var(--border-color);padding-bottom:15px;margin-bottom:15px;">
    <input type="date" id="dataInicioBusca" placeholder="Data in√≠cio" style="flex:1;min-width:150px;">
    <input type="date" id="dataFimBusca" placeholder="Data fim" style="flex:1;min-width:150px;">
    <button onclick="buscarPeriodo()">üîç Buscar Per√≠odo</button>
    <button onclick="voltarHoje()">üìÖ Hoje</button>
</div>

<div class="view-controls no-print">
    <button id="btnMensal" class="active" onclick="mudarVisualizacao('mensal')">üìÖ Mensal</button>
    <button id="btnSemanal" onclick="mudarVisualizacao('semanal')">üìã Semanal</button>
    <button id="btnMultiMes" onclick="mudarVisualizacao('multimes')">üìä V√°rios Meses</button>
    <select id="qtdMeses" onchange="renderMultiMes()" style="display:none;">
        <option value="3">3 meses</option>
        <option value="6" selected>6 meses</option>
        <option value="12">12 meses</option>
    </select>
    <button onclick="exportarPDF()">üìÑ Exportar PDF</button>
</div>

<div id="viewMensal">
    <div class="mes-navegacao">
        <button onclick="navegarMes(-1)">‚óÄ Anterior</button>
        <h3 id="mesAtual"></h3>
        <button onclick="navegarMes(1)">Pr√≥ximo ‚ñ∂</button>
    </div>
    <div id="calendario" class="calendario-mini"></div>
</div>

<div id="viewSemanal" class="oculto"></div>
<div id="viewMultiMes" class="oculto"></div>

<div class="legenda">
    <div class="legenda-item">
        <span class="legenda-cor" style="background:#27ae60;"></span>
        Servi√ßo Normal
    </div>
    <div class="legenda-item">
        <span class="legenda-cor" style="background:#3498db;"></span>
        Servi√ßo Extra
    </div>
    <div class="legenda-item">
        <span class="legenda-cor" style="background:#e67e22;"></span>
        Falta/Atestado
    </div>
    <div class="legenda-item">
        <span class="legenda-cor" style="background:#f0f0f0;border:1px solid #ccc;"></span>
        Folga
    </div>
</div>
</div>

<!-- ESCALAS AVULSAS -->
<div class="card no-print">
<h2>‚ûï Escala Avulsa</h2>
<form id="formEscala">
<input type="text" id="nome" placeholder="Nome" required>
<input type="text" id="funcao" placeholder="Fun√ß√£o" required>
<input type="date" id="data" required>
<select id="turno">
<option value="Diurno">Diurno</option>
<option value="Noturno">Noturno</option>
<option value="Manh√£">Manh√£</option>
<option value="Tarde">Tarde</option>
<option value="Noite">Noite</option>
<option value="24h">24h</option>
</select>
<select id="tipoServicoAvulso" required>
<option value="normal">üü¢ Normal</option>
<option value="extra">üîµ Extra</option>
<option value="falta">üü† Falta/Atestado</option>
</select>
<textarea id="motivoAvulso" placeholder="Motivo (opcional)" style="grid-column:1/-1;resize:vertical;"></textarea>
<button type="submit" style="grid-column:1/-1;">Adicionar</button>
</form>

<div style="overflow-x:auto;">
<table>
<thead>
<tr>
<th>Nome</th>
<th>Fun√ß√£o</th>
<th>Data</th>
<th>Turno</th>
<th>Tipo</th>
<th>A√ß√µes</th>
</tr>
</thead>
<tbody id="listaEscala"></tbody>
</table>
</div>
</div>

<!-- DATAS IMPORTANTES -->
<div class="card no-print">
<h2>‚≠ê Datas Importantes</h2>
<form id="formEvento">
<input type="date" id="dataEvento" required>
<input type="text" id="descricaoEvento" placeholder="Descri√ß√£o" required>
<button type="submit">Adicionar</button>
</form>

<table>
<thead>
<tr>
<th>Data</th>
<th>Descri√ß√£o</th>
<th>A√ß√µes</th>
</tr>
</thead>
<tbody id="listaEventos"></tbody>
</table>
</div>

<footer class="no-print">
Sistema de Escala - Google Sheets Integrado ‚Ä¢ Sincroniza√ß√£o Autom√°tica ‚Ä¢ v3.0
</footer>

</div>

<script>
// ========================================
// ‚ö° GOOGLE SHEETS INTEGRATION
// ========================================

const API_URL = "https://script.google.com/macros/s/AKfycbzSFcfnIbnmj4MdN1f2biPRzmIC9lcr8CUA6oKxbUguOA-praBpeU5v01dFJn1lNJnbRQ/exec";
let usarGoogleSheets = (API_URL !== "COLE_SUA_URL_AQUI");
let isSyncing = false;
let syncInterval = null;
let escalas = [];
let eventos = [];
let escalasPlantonistas = [];
let mesAtualVizualizado = new Date();
let visualizacaoAtual = 'mensal';

// ========================================
// INTEGRA√á√ÉO GOOGLE SHEETS
// ========================================

async function carregarDadosDoSheets() {
    if (!usarGoogleSheets) {
        carregarDadosLocal();
        return;
    }
    
    if (isSyncing) return;
    isSyncing = true;
    updateSyncStatus('Sincronizando...', 'syncing');
    
    try {
        const response = await fetch(`${API_URL}?action=sync&_=${Date.now()}`);
        const data = await response.json();
        
        if (data.success) {
            escalasPlantonistas = data.escalasPlantonistas || [];
            escalas = data.escalasAvulsas || [];
            eventos = data.eventos || [];
            
            // Gerar datas APENAS para escalas recorrentes
            escalasPlantonistas.forEach(e => {
                // Se j√° tem datas OU n√£o √© recorrente, n√£o gerar
                if (e.datas && e.datas.length > 0) {
                    // J√° tem datas, n√£o precisa gerar
                    return;
                }
                
                // Se √© n√£o-recorrente (extra/falta), n√£o gerar datas
                if (e.tipoOriginal === 'nao-recorrente') {
                    // As datas j√° foram criadas ao salvar
                    return;
                }
                
                // Apenas para escalas recorrentes normais
                if (e.tipoOriginal && e.tipoOriginal !== 'nao-recorrente') {
                    e.datas = gerarDatasEscala(
                        e.dataInicio, 
                        e.mesAte, 
                        e.tipoOriginal, 
                        e.horasTrabalho, 
                        e.horasFolga, 
                        e.opcoes || {}
                    );
                }
            });
            
            renderizarTudo();
            updateSyncStatus('Sincronizado ‚òÅÔ∏è', 'success');
        }
    } catch (error) {
        console.error('Erro:', error);
        updateSyncStatus('Offline', 'error');
        carregarDadosLocal();
    } finally {
        isSyncing = false;
    }
}

async function salvarNoSheets(dados, tipo) {
    if (!usarGoogleSheets) {
        salvarDadosLocal();
        return { success: true };
    }
    
    updateSyncStatus('Salvando...', 'syncing');
    
    try {
        const formData = new FormData();
        formData.append('action', tipo);
        formData.append('data', JSON.stringify(dados));
        
        const response = await fetch(API_URL, { method: 'POST', body: formData });
        const result = await response.json();
        
        if (result.success) {
            updateSyncStatus('Salvo!', 'success');
            setTimeout(() => carregarDadosDoSheets(), 1000);
        }
        
        return result;
    } catch (error) {
        console.error('Erro:', error);
        salvarDadosLocal();
        return { success: false };
    }
}

async function excluirDoSheets(id, tipo, index) {
    if (!usarGoogleSheets) {
        salvarDadosLocal();
        renderizarTudo();
        return;
    }
    
    let url = `${API_URL}?action=${tipo}`;
    if (id) url += `&id=${id}`;
    if (index !== undefined) url += `&index=${index}`;
    
    await fetch(url);
    setTimeout(() => carregarDadosDoSheets(), 1000);
}

function updateSyncStatus(msg, status) {
    const ind = document.getElementById('syncIndicator');
    const txt = document.getElementById('syncStatus');
    const api = document.getElementById('apiStatus');
    
    if (ind) ind.className = 'sync-indicator ' + status;
    if (txt) txt.textContent = msg;
    if (api) {
        api.innerHTML = usarGoogleSheets ? 
            '‚úÖ <strong>Google Sheets Conectado</strong> - Dados sincronizados' : 
            '‚ö†Ô∏è <strong>Modo Offline</strong> - Dados no navegador';
        api.style.color = usarGoogleSheets ? '#27ae60' : '#e67e22';
    }
    
    if (status === 'success') {
        setTimeout(() => {
            if (txt) txt.textContent = 'Sincronizado ‚òÅÔ∏è';
            if (ind) ind.className = 'sync-indicator';
        }, 2000);
    }
}

function renderizarTudo() {
    renderEscalasPlantonistas();
    renderEscala();
    renderEventos();
    atualizarVisualizacao();
    calcularEstatisticas();
}

// ========================================
// DADOS LOCAIS (FALLBACK)
// ========================================

function carregarDadosLocal(){
    escalas = JSON.parse(localStorage.getItem("escalas")) || [];
    eventos = JSON.parse(localStorage.getItem("eventos")) || [];
    escalasPlantonistas = JSON.parse(localStorage.getItem("escalasPlantonistas")) || [];
    
    escalasPlantonistas.forEach(e => {
        // Se j√° tem datas, n√£o gerar novamente
        if (e.datas && e.datas.length > 0) {
            return;
        }
        
        // Se √© n√£o-recorrente (extra/falta), n√£o gerar datas
        if (e.tipoOriginal === 'nao-recorrente') {
            return;
        }
        
        // Apenas para escalas recorrentes
        if (e.tipoOriginal && e.tipoOriginal !== 'nao-recorrente') {
            e.datas = gerarDatasEscala(
                e.dataInicio, 
                e.mesAte, 
                e.tipoOriginal, 
                e.horasTrabalho, 
                e.horasFolga, 
                e.opcoes || {}
            );
        }
    });
    
    renderizarTudo();
}

function salvarDadosLocal(){
    if(usarGoogleSheets) return; // N√£o salvar local se estiver usando Sheets
    localStorage.setItem("escalas", JSON.stringify(escalas));
    localStorage.setItem("eventos", JSON.stringify(eventos));
    localStorage.setItem("escalasPlantonistas", JSON.stringify(escalasPlantonistas));
}

function toggleTheme(){
    document.body.classList.toggle('dark-mode');
    localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
}

// Carregar tema salvo
if(localStorage.getItem('darkMode') === 'true'){
    document.body.classList.add('dark-mode');
}

function ajustarCamposTipoServico(){
    const tipoServico = document.getElementById("tipoServico").value;
    const camposExtraFalta = document.getElementById("camposExtraFalta");
    const camposRecorrentes = document.getElementById("camposRecorrentes");
    
    if(tipoServico === 'extra' || tipoServico === 'falta'){
        camposExtraFalta.classList.remove("oculto");
        camposRecorrentes.style.display = "none";
        
        document.getElementById("tipoEscala").removeAttribute("required");
        document.getElementById("dataInicioPlantonista").removeAttribute("required");
        document.getElementById("mesFimPlantonista").removeAttribute("required");
        
        document.getElementById("dataUnicaServico").setAttribute("required", "required");
        document.getElementById("qtdDiasServico").setAttribute("required", "required");
    } else {
        camposExtraFalta.classList.add("oculto");
        camposRecorrentes.style.display = "contents";
        
        document.getElementById("tipoEscala").setAttribute("required", "required");
        document.getElementById("dataInicioPlantonista").setAttribute("required", "required");
        document.getElementById("mesFimPlantonista").setAttribute("required", "required");
        
        document.getElementById("dataUnicaServico").removeAttribute("required");
        document.getElementById("qtdDiasServico").removeAttribute("required");
    }
}

function ajustarCamposEscala(){
    const tipo = document.getElementById("tipoEscala").value;
    const camposPersonalizada = document.getElementById("camposPersonalizada");
    const camposDiaPosterior = document.getElementById("camposDiaPosterior");
    
    camposPersonalizada.classList.add("oculto");
    camposDiaPosterior.classList.add("oculto");
    
    if(tipo === "personalizada"){
        camposPersonalizada.classList.remove("oculto");
    }
    
    if(tipo === "12x24-12x72" || tipo === "12x24-12x48" || tipo === "12x24-12x96"){
        camposDiaPosterior.classList.remove("oculto");
    }
}

function gerarDatasEscala(dataInicio, mesAte, tipo, horasTrabalho, horasFolga, opcoes = {}){
    const datas = [];
    
    // Prote√ß√£o: se n√£o tem tipo ou √© nao-recorrente, retornar vazio
    if (!tipo || tipo === 'nao-recorrente') {
        return [];
    }
    
    const inicio = new Date(dataInicio + "T00:00:00");
    const [anoFim, mesFim] = mesAte.split("-");
    const dataLimite = new Date(parseInt(anoFim), parseInt(mesFim), 0);
    
    let dataAtual = new Date(inicio);
    let iteracoes = 0;
    const MAX_ITERACOES = 10000; // Prote√ß√£o contra loop infinito
    
    if(tipo === "12x24-12x72" || tipo === "12x24-12x48" || tipo === "12x24-12x96"){
        const horasFolgaFinal = tipo === "12x24-12x72" ? 72 : tipo === "12x24-12x48" ? 48 : 96;
        const marcarDiaPosterior = opcoes.marcarDiaPosterior || false;
        const diasTrabalho = marcarDiaPosterior ? 2 : 1;
        
        while(dataAtual <= dataLimite && iteracoes < MAX_ITERACOES){
            iteracoes++;
            
            for(let d = 0; d < diasTrabalho; d++){
                if(dataAtual <= dataLimite){
                    const dataStr = new Date(dataAtual).toISOString().split("T")[0];
                    
                    datas.push({
                        data: dataStr,
                        turno: "Diurno"
                    });
                    
                    datas.push({
                        data: dataStr,
                        turno: "Noturno"
                    });
                    
                    dataAtual.setDate(dataAtual.getDate() + 1);
                }
            }
            
            const diasFolga = horasFolgaFinal / 24;
            dataAtual.setDate(dataAtual.getDate() + diasFolga);
        }
    }
    else if(tipo === "diario-8h"){
        while(dataAtual <= dataLimite && iteracoes < MAX_ITERACOES){
            iteracoes++;
            const diaSemana = dataAtual.getDay();
            if(diaSemana !== 0 && diaSemana !== 6){
                datas.push({
                    data: new Date(dataAtual).toISOString().split("T")[0],
                    turno: "08:00-16:00"
                });
            }
            dataAtual.setDate(dataAtual.getDate() + 1);
        }
    }
    else {
        let emServico = true;
        const incluirFinaisSemana = opcoes.incluirFinaisSemana !== undefined ? opcoes.incluirFinaisSemana : true;
        
        while(dataAtual <= dataLimite && iteracoes < MAX_ITERACOES){
            iteracoes++;
            const diaSemana = dataAtual.getDay();
            const ehFinalSemana = diaSemana === 0 || diaSemana === 6;
            
            if(emServico && (incluirFinaisSemana || !ehFinalSemana)){
                datas.push({
                    data: new Date(dataAtual).toISOString().split("T")[0],
                    turno: horasTrabalho === 24 ? "24h" : "Plant√£o"
                });
            }
            
            const horasAdicionar = emServico ? horasTrabalho : horasFolga;
            dataAtual.setHours(dataAtual.getHours() + horasAdicionar);
            emServico = !emServico;
        }
    }
    
    if(iteracoes >= MAX_ITERACOES){
        console.error("AVISO: Loop infinito detectado em gerarDatasEscala. Interrompido.");
    }
    
    return datas;
}

function calcularHorasEscala(tipo){
    switch(tipo){
        case "12x24-12x72": return {trabalho: 12, folga: 72};
        case "12x24-12x48": return {trabalho: 12, folga: 48};
        case "12x24-12x96": return {trabalho: 12, folga: 96};
        case "diario-8h": return {trabalho: 8, folga: 0};
        case "24x48": return {trabalho: 24, folga: 48};
        case "24x72": return {trabalho: 24, folga: 72};
        default: return null;
    }
}

document.getElementById("formEscalaPlantonista").addEventListener("submit", async (e) => {
    e.preventDefault();
    
    const tipoServico = document.getElementById("tipoServico").value;
    const nome = document.getElementById("nomePlantonista").value;
    const funcao = document.getElementById("funcaoPlantonista").value;
    const turno = document.getElementById("turnoPlantonista").value;
    const motivo = document.getElementById("motivoServico").value;
    
    if(tipoServico === 'extra' || tipoServico === 'falta'){
        const dataInicio = document.getElementById("dataUnicaServico").value;
        const qtdDias = parseInt(document.getElementById("qtdDiasServico").value);
        
        const datas = [];
        const dataBase = new Date(dataInicio + "T00:00:00");
        
        for(let i = 0; i < qtdDias; i++){
            const data = new Date(dataBase);
            data.setDate(data.getDate() + i);
            datas.push({
                data: data.toISOString().split("T")[0],
                turno: turno
            });
        }
        
        const escala = {
            id: Date.now(),
            nome, funcao, tipoServico,
            tipoEscala: `${qtdDias} dia(s)`,
            tipoOriginal: 'nao-recorrente',
            dataInicio, mesAte: dataInicio.substring(0, 7),
            turno, motivo, qtdDias, datas
        };
        
        escalasPlantonistas.push(escala);
        await salvarNoSheets(escala, 'saveEscalaPlantonista');
        e.target.reset();
        ajustarCamposTipoServico();
        return;
    }
    
    const tipo = document.getElementById("tipoEscala").value;
    let horasTrabalho, horasFolga;
    let tipoEscalaDisplay = tipo;
    
    const opcoes = {};
    
    if(tipo === "12x24-12x72" || tipo === "12x24-12x48" || tipo === "12x24-12x96"){
        opcoes.marcarDiaPosterior = document.getElementById("marcarDiaPosterior").checked;
    }
    
    if(tipo === "personalizada"){
        horasTrabalho = parseInt(document.getElementById("horasTrabalho").value);
        horasFolga = parseInt(document.getElementById("horasFolga").value);
        tipoEscalaDisplay = `${horasTrabalho}x${horasFolga}`;
        opcoes.incluirFinaisSemana = document.getElementById("incluirFinaisSemana").checked;
    } else {
        const horas = calcularHorasEscala(tipo);
        horasTrabalho = horas.trabalho;
        horasFolga = horas.folga;
    }
    
    const escala = {
        id: Date.now(),
        nome, funcao, tipoServico,
        tipoEscala: tipoEscalaDisplay,
        tipoOriginal: tipo,
        dataInicio: document.getElementById("dataInicioPlantonista").value,
        mesAte: document.getElementById("mesFimPlantonista").value,
        turno, motivo,
        horasTrabalho, horasFolga, opcoes,
        datas: gerarDatasEscala(
            document.getElementById("dataInicioPlantonista").value,
            document.getElementById("mesFimPlantonista").value,
            tipo, horasTrabalho, horasFolga, opcoes
        )
    };
    
    escalasPlantonistas.push(escala);
    await salvarNoSheets(escala, 'saveEscalaPlantonista');
    e.target.reset();
    ajustarCamposEscala();
    ajustarCamposTipoServico();
});

function renderEscalasPlantonistas(){
    const lista = document.getElementById("listaEscalasPlantonistas");
    lista.innerHTML = "";
    escalasPlantonistas.forEach((e)=>{
        const [ano, mes] = e.mesAte.split("-");
        const mesFormatado = `${mes}/${ano}`;
        
        let tipoDisplay = e.tipoEscala;
        const tipoServicoIcon = e.tipoServico === 'normal' ? 'üü¢' : e.tipoServico === 'extra' ? 'üîµ' : 'üü†';
        
        if(e.tipoOriginal === "12x24-12x72") tipoDisplay = "12x24+12x72";
        if(e.tipoOriginal === "12x24-12x48") tipoDisplay = "12x24+12x48";
        if(e.tipoOriginal === "12x24-12x96") tipoDisplay = "12x24+12x96";
        if(e.tipoOriginal === "diario-8h") tipoDisplay = "Di√°rio 8h";
        
        if(e.opcoes && e.opcoes.marcarDiaPosterior) tipoDisplay += " (2d)";
        if(e.opcoes && e.opcoes.incluirFinaisSemana) tipoDisplay += " (c/FDS)";
        if(e.opcoes && e.opcoes.incluirFinaisSemana === false) tipoDisplay += " (s/FDS)";
        
        lista.innerHTML += `
        <tr>
            <td>${e.nome}</td>
            <td>${e.funcao}</td>
            <td>${tipoServicoIcon}</td>
            <td>${tipoDisplay}</td>
            <td>${e.dataInicio.split("-").reverse().join("/")}</td>
            <td>${mesFormatado}</td>
            <td>
                <button class="btn-edit" onclick="editarEscalaPlantonista(${e.id})">Editar</button>
                <button class="btn-del" onclick="delEscalaPlantonista(${e.id})">Excluir</button>
            </td>
        </tr>`;
    });
}

function editarEscalaPlantonista(id){
    const escala = escalasPlantonistas.find(e => e.id === id);
    if(!escala) return;
    
    document.getElementById("formEscalaPlantonista").reset();
    document.getElementById("formEscalaPlantonista").scrollIntoView({ behavior: 'smooth', block: 'start' });
    
    document.getElementById("nomePlantonista").value = escala.nome;
    document.getElementById("funcaoPlantonista").value = escala.funcao;
    document.getElementById("tipoServico").value = escala.tipoServico;
    document.getElementById("turnoPlantonista").value = escala.turno;
    document.getElementById("motivoServico").value = escala.motivo || "";
    
    ajustarCamposTipoServico();
    
    setTimeout(() => {
        if(escala.tipoServico === 'extra' || escala.tipoServico === 'falta'){
            document.getElementById("dataUnicaServico").value = escala.dataInicio;
            document.getElementById("qtdDiasServico").value = escala.qtdDias || 1;
        } else {
            document.getElementById("dataInicioPlantonista").value = escala.dataInicio;
            document.getElementById("mesFimPlantonista").value = escala.mesAte;
            
            const tipo = escala.tipoOriginal || escala.tipoEscala;
            
            if(tipo && tipo !== "nao-recorrente"){
                if(tipo === "personalizada" || (!["12x24-12x72","12x24-12x48","12x24-12x96","diario-8h","24x48","24x72"].includes(tipo))){
                    document.getElementById("tipoEscala").value = "personalizada";
                    ajustarCamposEscala();
                    
                    setTimeout(() => {
                        if(escala.horasTrabalho){
                            document.getElementById("horasTrabalho").value = escala.horasTrabalho;
                            document.getElementById("horasFolga").value = escala.horasFolga;
                        }
                        if(escala.opcoes && escala.opcoes.incluirFinaisSemana !== undefined){
                            document.getElementById("incluirFinaisSemana").checked = escala.opcoes.incluirFinaisSemana;
                        }
                    }, 50);
                } else {
                    document.getElementById("tipoEscala").value = tipo;
                    ajustarCamposEscala();
                    
                    setTimeout(() => {
                        if(tipo === "12x24-12x72" || tipo === "12x24-12x48" || tipo === "12x24-12x96"){
                            if(escala.opcoes && escala.opcoes.marcarDiaPosterior !== undefined){
                                document.getElementById("marcarDiaPosterior").checked = escala.opcoes.marcarDiaPosterior;
                            }
                        }
                    }, 50);
                }
            }
        }
    }, 100);
    
    escalasPlantonistas = escalasPlantonistas.filter(e => e.id !== id);
    salvarDadosLocal();
    renderEscalasPlantonistas();
    atualizarVisualizacao();
    calcularEstatisticas();
}

async function delEscalaPlantonista(id){
    if(!confirm("Deseja excluir esta escala?")) return;
    escalasPlantonistas = escalasPlantonistas.filter(e => e.id !== id);
    await excluirDoSheets(id, 'deleteEscalaPlantonista');
}

function obterInfoServico(data){
    let servicos = [];
    
    for(let escala of escalasPlantonistas){
        if(escala.datas && Array.isArray(escala.datas)){
            for(let dia of escala.datas){
                const diaData = typeof dia === 'object' ? dia.data : dia;
                const diaTurno = typeof dia === 'object' ? dia.turno : escala.turno;
                
                if(diaData === data){
                    servicos.push({
                        nome: escala.nome,
                        turno: diaTurno,
                        tipo: escala.tipoServico,
                        motivo: escala.motivo
                    });
                }
            }
        }
    }
    
    for(let escala of escalas){
        if(escala.data === data){
            servicos.push({
                nome: escala.nome,
                turno: escala.turno,
                tipo: escala.tipoServico,
                motivo: escala.motivo
            });
        }
    }
    
    if(servicos.length > 0){
        const tipo = servicos[0].tipo;
        let descricao = "Servi√ßo:\n";
        servicos.forEach(s => {
            descricao += `${s.nome} - ${s.turno}`;
            if(s.motivo) descricao += ` (${s.motivo})`;
            descricao += "\n";
        });
        
        return { temServico: true, tipo: tipo, descricao: descricao.trim() };
    }
    
    return { temServico: false, tipo: null, descricao: "Folga" };
}

function renderCalendario(){
    const ano = mesAtualVizualizado.getFullYear();
    const mes = mesAtualVizualizado.getMonth();
    
    document.getElementById("mesAtual").textContent = 
        mesAtualVizualizado.toLocaleDateString("pt-BR", {month: "long", year: "numeric"});
    
    const primeiroDia = new Date(ano, mes, 1).getDay();
    const ultimoDia = new Date(ano, mes + 1, 0).getDate();
    
    const calendario = document.getElementById("calendario");
    calendario.innerHTML = "";
    
    ["Dom", "Seg", "Ter", "Qua", "Qui", "Sex", "S√°b"].forEach(dia => {
        const div = document.createElement("div");
        div.className = "dia-calendario dia-header";
        div.textContent = dia;
        calendario.appendChild(div);
    });
    
    for(let i = 0; i < primeiroDia; i++){
        const div = document.createElement("div");
        div.className = "dia-calendario";
        calendario.appendChild(div);
    }
    
    const hoje = new Date();
    hoje.setHours(0,0,0,0);
    
    for(let dia = 1; dia <= ultimoDia; dia++){
        const dataAtual = `${ano}-${String(mes + 1).padStart(2, "0")}-${String(dia).padStart(2, "0")}`;
        const infoServico = obterInfoServico(dataAtual);
        
        const dataCalendario = new Date(ano, mes, dia);
        const ehPassado = dataCalendario < hoje;
        
        const div = document.createElement("div");
        let className = "dia-calendario ";
        
        if(infoServico.temServico){
            className += `dia-servico-${infoServico.tipo}`;
        } else {
            className += "dia-folga";
        }
        
        if(ehPassado) className += " dia-passado";
        
        div.className = className;
        div.textContent = dia;
        div.title = infoServico.descricao;
        calendario.appendChild(div);
    }
}

function navegarMes(direcao){
    mesAtualVizualizado.setMonth(mesAtualVizualizado.getMonth() + direcao);
    renderCalendario();
}

function renderSemanal(){
    const inicio = new Date(mesAtualVizualizado);
    inicio.setDate(inicio.getDate() - inicio.getDay());
    
    const viewSemanal = document.getElementById("viewSemanal");
    viewSemanal.innerHTML = `
        <div class="mes-navegacao">
            <button onclick="navegarSemana(-1)">‚óÄ Semana Anterior</button>
            <h3>Semana de ${inicio.toLocaleDateString("pt-BR")}</h3>
            <button onclick="navegarSemana(1)">Pr√≥xima Semana ‚ñ∂</button>
        </div>
        <div class="semana-grid" id="semanaGrid"></div>
    `;
    
    const grid = document.getElementById("semanaGrid");
    const diasSemana = ["Domingo", "Segunda", "Ter√ßa", "Quarta", "Quinta", "Sexta", "S√°bado"];
    
    for(let i = 0; i < 7; i++){
        const data = new Date(inicio);
        data.setDate(data.getDate() + i);
        const dataStr = data.toISOString().split("T")[0];
        const infoServico = obterInfoServico(dataStr);
        
        const card = document.createElement("div");
        card.className = "dia-semana-card";
        
        let html = `<h5>${diasSemana[i]}<br>${data.getDate()}/${data.getMonth()+1}</h5>`;
        
        if(infoServico.temServico){
            const servicos = infoServico.descricao.split("\n").slice(1);
            servicos.forEach(s => {
                if(s.trim()){
                    html += `<div class="servico-item servico-${infoServico.tipo}">${s}</div>`;
                }
            });
        } else {
            html += `<div style="text-align:center;padding:20px;opacity:0.5;">Folga</div>`;
        }
        
        card.innerHTML = html;
        grid.appendChild(card);
    }
}

function navegarSemana(direcao){
    mesAtualVizualizado.setDate(mesAtualVizualizado.getDate() + (direcao * 7));
    renderSemanal();
}

function renderMultiMes(){
    const qtd = parseInt(document.getElementById("qtdMeses").value);
    const viewMultiMes = document.getElementById("viewMultiMes");
    viewMultiMes.innerHTML = '<div class="multi-month-grid" id="multiMesGrid"></div>';
    
    const grid = document.getElementById("multiMesGrid");
    const mesInicial = new Date(mesAtualVizualizado);
    
    for(let m = 0; m < qtd; m++){
        const mesAtual = new Date(mesInicial);
        mesAtual.setMonth(mesAtual.getMonth() + m);
        
        const card = document.createElement("div");
        card.className = "month-card";
        
        const ano = mesAtual.getFullYear();
        const mes = mesAtual.getMonth();
        const nomeMes = mesAtual.toLocaleDateString("pt-BR", {month: "long", year: "numeric"});
        
        const primeiroDia = new Date(ano, mes, 1).getDay();
        const ultimoDia = new Date(ano, mes + 1, 0).getDate();
        
        let html = `<h4>${nomeMes}</h4><div class="calendario-mini">`;
        
        ["D", "S", "T", "Q", "Q", "S", "S"].forEach(dia => {
            html += `<div class="dia-calendario dia-header">${dia}</div>`;
        });
        
        for(let i = 0; i < primeiroDia; i++){
            html += `<div class="dia-calendario"></div>`;
        }
        
        for(let dia = 1; dia <= ultimoDia; dia++){
            const dataAtual = `${ano}-${String(mes + 1).padStart(2, "0")}-${String(dia).padStart(2, "0")}`;
            const infoServico = obterInfoServico(dataAtual);
            
            let className = "dia-calendario ";
            if(infoServico.temServico){
                className += `dia-servico-${infoServico.tipo}`;
            } else {
                className += "dia-folga";
            }
            
            html += `<div class="${className}" title="${infoServico.descricao}">${dia}</div>`;
        }
        
        html += `</div>`;
        card.innerHTML = html;
        grid.appendChild(card);
    }
}

function buscarPeriodo(){
    const dataInicio = document.getElementById("dataInicioBusca").value;
    const dataFim = document.getElementById("dataFimBusca").value;
    
    if(!dataInicio && !dataFim){
        alert("Por favor, informe pelo menos uma data para buscar.");
        return;
    }
    
    if(dataInicio){
        const [ano, mes] = dataInicio.split("-");
        mesAtualVizualizado = new Date(parseInt(ano), parseInt(mes) - 1, 1);
        atualizarVisualizacao();
    }
    
    if(dataInicio && dataFim){
        const inicio = new Date(dataInicio);
        const fim = new Date(dataFim);
        const diffMeses = (fim.getFullYear() - inicio.getFullYear()) * 12 + (fim.getMonth() - inicio.getMonth());
        
        if(diffMeses > 0){
            mudarVisualizacao('multimes');
            const qtdSelect = document.getElementById("qtdMeses");
            if(diffMeses <= 3) qtdSelect.value = "3";
            else if(diffMeses <= 6) qtdSelect.value = "6";
            else qtdSelect.value = "12";
            renderMultiMes();
        }
    }
}

function voltarHoje(){
    mesAtualVizualizado = new Date();
    document.getElementById("dataInicioBusca").value = "";
    document.getElementById("dataFimBusca").value = "";
    mudarVisualizacao('mensal');
}

function mudarVisualizacao(tipo){
    visualizacaoAtual = tipo;
    
    document.getElementById("btnMensal").classList.remove("active");
    document.getElementById("btnSemanal").classList.remove("active");
    document.getElementById("btnMultiMes").classList.remove("active");
    
    document.getElementById("viewMensal").classList.add("oculto");
    document.getElementById("viewSemanal").classList.add("oculto");
    document.getElementById("viewMultiMes").classList.add("oculto");
    document.getElementById("qtdMeses").style.display = "none";
    
    if(tipo === 'mensal'){
        document.getElementById("btnMensal").classList.add("active");
        document.getElementById("viewMensal").classList.remove("oculto");
        renderCalendario();
    } else if(tipo === 'semanal'){
        document.getElementById("btnSemanal").classList.add("active");
        document.getElementById("viewSemanal").classList.remove("oculto");
        renderSemanal();
    } else if(tipo === 'multimes'){
        document.getElementById("btnMultiMes").classList.add("active");
        document.getElementById("viewMultiMes").classList.remove("oculto");
        document.getElementById("qtdMeses").style.display = "block";
        renderMultiMes();
    }
}

function atualizarVisualizacao(){
    if(visualizacaoAtual === 'mensal') renderCalendario();
    else if(visualizacaoAtual === 'semanal') renderSemanal();
    else if(visualizacaoAtual === 'multimes') renderMultiMes();
}

function calcularEstatisticas(){
    let normais = 0, extras = 0, faltas = 0, dispensaMedica = 0, avulsoCount = 0;
    let datasNormais = new Set();
    let datasExtras = new Set();
    let datasFaltas = new Set();
    let datasDispensa = new Set();
    let datasAvulso = new Set();
    
    escalasPlantonistas.forEach(e => {
        if(e.datas && Array.isArray(e.datas)){
            e.datas.forEach(d => {
                const data = typeof d === 'object' ? d.data : d;
                
                if(e.tipoServico === 'normal'){
                    datasNormais.add(data);
                } else if(e.tipoServico === 'extra'){
                    datasExtras.add(data);
                } else if(e.tipoServico === 'falta'){
                    if(e.datas.length > 8){
                        datasDispensa.add(data);
                    } else {
                        datasFaltas.add(data);
                    }
                }
            });
        }
    });
    
    escalas.forEach(e => {
        avulsoCount++;
        datasAvulso.add(e.data);
        
        if(e.tipoServico === 'normal') {
            datasNormais.add(e.data);
        } else if(e.tipoServico === 'extra') {
            datasExtras.add(e.data);
        } else if(e.tipoServico === 'falta') {
            datasFaltas.add(e.data);
        }
    });
    
    normais = datasNormais.size;
    extras = datasExtras.size;
    faltas = datasFaltas.size;
    dispensaMedica = datasDispensa.size;
    const avulsoDias = datasAvulso.size;
    
    let totalFolgas = 0;
    let totalDiasPeriodo = 0;
    let todasDatas = new Set([...datasNormais, ...datasExtras, ...datasFaltas, ...datasDispensa, ...datasAvulso]);
    
    if(todasDatas.size > 0){
        const datasArray = Array.from(todasDatas).sort();
        const primeiraData = datasArray[0];
        const ultimaData = datasArray[datasArray.length - 1];
        
        const [anoInicio, mesInicio] = primeiraData.split('-').map(Number);
        const [anoFim, mesFim] = ultimaData.split('-').map(Number);
        
        if(primeiraData === `${anoInicio}-01-01` && ultimaData === `${anoFim}-12-31` && anoInicio === anoFim){
            const ehBissexto = (anoInicio % 4 === 0 && anoInicio % 100 !== 0) || (anoInicio % 400 === 0);
            totalDiasPeriodo = ehBissexto ? 366 : 365;
        } else {
            const dataMinima = new Date(primeiraData + 'T00:00:00');
            const dataMaxima = new Date(ultimaData + 'T00:00:00');
            const diffTime = dataMaxima.getTime() - dataMinima.getTime();
            totalDiasPeriodo = Math.floor(diffTime / (1000 * 60 * 60 * 24)) + 1;
        }
        
        const diasTrabalhados = normais + extras + avulsoDias + dispensaMedica;
        totalFolgas = totalDiasPeriodo - diasTrabalhados;
        if(totalFolgas < 0) totalFolgas = 0;
    }
    
    document.getElementById("statNormais").textContent = normais;
    document.getElementById("statExtras").textContent = extras;
    document.getElementById("statFaltas").textContent = faltas;
    document.getElementById("statDispensa").textContent = dispensaMedica;
    document.getElementById("statAvulso").textContent = avulsoCount;
    document.getElementById("statFolgas").textContent = totalFolgas;
    document.getElementById("statTotal").textContent = normais + extras + faltas + dispensaMedica;
}

async function exportarPDF(){
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('p', 'mm', 'a4');
    
    const elemento = document.querySelector('.card');
    const canvas = await html2canvas(elemento, {
        scale: 2,
        backgroundColor: '#ffffff'
    });
    
    const imgData = canvas.toDataURL('image/png');
    const imgWidth = 190;
    const imgHeight = (canvas.height * imgWidth) / canvas.width;
    
    pdf.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeight);
    pdf.save('escala-servico.pdf');
}

function renderEscala(){
    const lista = document.getElementById("listaEscala");
    lista.innerHTML = "";
    escalas.forEach((e,i)=>{
        const tipoIcon = e.tipoServico === 'normal' ? 'üü¢' : e.tipoServico === 'extra' ? 'üîµ' : 'üü†';
        lista.innerHTML += `
        <tr>
            <td>${e.nome}</td>
            <td>${e.funcao}</td>
            <td>${e.data.split("-").reverse().join("/")}</td>
            <td>${e.turno}</td>
            <td>${tipoIcon}</td>
            <td>
                <button class="btn-edit" onclick="editarEscala(${i})">Editar</button>
                <button class="btn-del" onclick="delEscala(${i})">Excluir</button>
            </td>
        </tr>`;
    });
}

function editarEscala(i){
    const e = escalas[i];
    
    document.getElementById("formEscala").reset();
    document.getElementById("formEscala").scrollIntoView({ behavior: 'smooth', block: 'start' });
    
    document.getElementById("nome").value = e.nome;
    document.getElementById("funcao").value = e.funcao;
    document.getElementById("data").value = e.data;
    document.getElementById("turno").value = e.turno;
    document.getElementById("tipoServicoAvulso").value = e.tipoServico;
    document.getElementById("motivoAvulso").value = e.motivo || "";
    
    escalas.splice(i, 1);
    salvarDadosLocal();
    renderEscala();
    atualizarVisualizacao();
    calcularEstatisticas();
}

function renderEventos(){
    const lista = document.getElementById("listaEventos");
    lista.innerHTML = "";
    eventos.forEach((e,i)=>{
        lista.innerHTML += `
        <tr>
            <td>${e.data.split("-").reverse().join("/")}</td>
            <td>${e.desc}</td>
            <td>
                <button class="btn-edit" onclick="editarEvento(${i})">Editar</button>
                <button class="btn-del" onclick="delEvento(${i})">Excluir</button>
            </td>
        </tr>`;
    });
}

function editarEvento(i){
    const e = eventos[i];
    
    document.getElementById("formEvento").reset();
    document.getElementById("formEvento").scrollIntoView({ behavior: 'smooth', block: 'start' });
    
    document.getElementById("dataEvento").value = e.data;
    document.getElementById("descricaoEvento").value = e.desc;
    
    eventos.splice(i, 1);
    salvarDadosLocal();
    renderEventos();
}

document.getElementById("formEscala").addEventListener("submit", async (e) => {
    e.preventDefault();
    const escala = {
        nome: nome.value,
        funcao: funcao.value,
        data: data.value,
        turno: turno.value,
        tipoServico: tipoServicoAvulso.value,
        motivo: motivoAvulso.value
    };
    escalas.push(escala);
    await salvarNoSheets(escala, 'saveEscalaAvulsa');
    e.target.reset();
});

document.getElementById("formEvento").addEventListener("submit", async (e) => {
    e.preventDefault();
    const evento = {
        data: dataEvento.value,
        desc: descricaoEvento.value
    };
    eventos.push(evento);
    await salvarNoSheets(evento, 'saveEvento');
    e.target.reset();
});

async function delEscala(i){
    if(!confirm("Deseja excluir esta escala?")) return;
    escalas.splice(i,1);
    await excluirDoSheets(null, 'deleteEscalaAvulsa', i);
}

async function delEvento(i){
    if(!confirm("Deseja excluir este evento?")) return;
    eventos.splice(i,1);
    await excluirDoSheets(null, 'deleteEvento', i);
}

// ========================================
// INICIALIZA√á√ÉO
// ========================================

window.addEventListener('DOMContentLoaded', () => {
    if (usarGoogleSheets) {
        carregarDadosDoSheets();
        syncInterval = setInterval(() => {
            if (!isSyncing) carregarDadosDoSheets();
        }, 5000);
    } else {
        carregarDadosLocal();
    }
    updateSyncStatus('Pronto', 'success');
});

window.addEventListener('beforeunload', () => {
    if (syncInterval) clearInterval(syncInterval);
});
</script>

</body>
</html>
